#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc (Dotfiles Flying Circus)
#
# DESCRIPTION:  This script is the main entry point and dispatcher for a suite
#               of custom shell commands. It uses a plugin-based architecture
#               to discover and execute subcommands.
#
# USAGE:        fc <command> [options]
#
# ==============================================================================

# --- Setup & Configuration --------------------------------------------------

# Source the helper library. This is critical as it sets up our error handling
# (set -e, traps) and provides the logging functions.
# The path is relative to the script's location.
source "$(dirname "${BASH_SOURCE[0]}")/../lib/helpers.sh"

# Define the absolute path to the directory where plugins are stored.
readonly PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../lib/plugins"

# --- Help and Usage ---------------------------------------------------------

# @description
#   Displays a general help message that dynamically lists all available
#   commands (plugins) and then exits.
usage() {
  msg_info "Usage: fc <command> [options]"
  echo ""
  msg_info "A modular, plugin-based command-line utility for system management."
  echo ""
  msg_info "Available commands:"

  # Scan the plugin directory for all executable files and print them.
  find "$PLUGIN_DIR" -maxdepth 1 -type f -executable -exec basename {} \; | sort | awk '{printf "  - %s\n", $1}'

  echo ""
  msg_info "Run 'fc <command> --help' for more information on a specific command."
  exit 0
}

# --- Dispatcher Logic -------------------------------------------------------

# If no arguments are provided, display the main usage message.
if [ -z "$1" ]; then
  usage
fi

# The first argument is the potential subcommand.
SUBCOMMAND="$1"

# Construct the full, absolute path to the corresponding plugin script.
PLUGIN_SCRIPT="$PLUGIN_DIR/$SUBCOMMAND"

# Check if a plugin script exists at the constructed path and is executable.
if [ -x "$PLUGIN_SCRIPT" ]; then
  # If the plugin is valid, transfer control to it.
  shift
  exec "$PLUGIN_SCRIPT" "$@"
else
  # If no valid plugin was found, use the `die` function to exit gracefully.
  die "Unknown command '$SUBCOMMAND'. Run 'fc --help' to see a list of available commands."
fi
