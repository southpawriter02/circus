#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc (Dotfiles Flying Circus)
#
# DESCRIPTION:  This script is the main entry point and dispatcher for a suite
#               of custom shell commands. It uses a plugin-based architecture
#               to discover and execute subcommands.
#
# USAGE:        fc [global options] <command> [command options]
#
# ==============================================================================

# --- Setup & Configuration --------------------------------------------------
# Source the helper library to get error handling and logging functions.
source "$(dirname "${BASH_SOURCE[0]}")/../lib/helpers.sh"

readonly PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../lib/plugins"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc [global options] <command> [command options]"
  echo ""
  msg_info "Global Options:"
  echo "  --log-file <path>  Redirect all log output to the specified file."
  echo "  --log-level <lvl>  Set the console log level (DEBUG, INFO, WARN, ERROR)."
  echo ""
  msg_info "A modular, plugin-based command-line utility for system management."
  echo ""
  msg_info "Available commands:"
  find "$PLUGIN_DIR" -maxdepth 1 -type f -executable -exec basename {} \; | sort
  echo ""
  msg_info "Run 'fc <command> --help' for more information on a specific command."
  exit 0
}

# --- Main Dispatcher Logic --------------------------------------------------

# First, parse any global options before we look for the subcommand.
while [[ $# -gt 0 ]]; do
  case "$1" in
    --log-file)
      export LOG_FILE_PATH="$2"
      mkdir -p "$(dirname "$LOG_FILE_PATH")"
      touch "$LOG_FILE_PATH"
      shift 2
      ;;
    --log-level)
      level_name=$(echo "$2" | tr '[:lower:]' '[:upper:]')
      case "$level_name" in
        DEBUG) export CONSOLE_LOG_LEVEL=$LOG_LEVEL_DEBUG ;; 
        INFO) export CONSOLE_LOG_LEVEL=$LOG_LEVEL_INFO ;; 
        WARN) export CONSOLE_LOG_LEVEL=$LOG_LEVEL_WARN ;; 
        ERROR) export CONSOLE_LOG_LEVEL=$LOG_LEVEL_ERROR ;; 
        CRITICAL) export CONSOLE_LOG_LEVEL=$LOG_LEVEL_CRITICAL ;; 
        *) die "Invalid log level: $2. Use DEBUG, INFO, WARN, or ERROR." ;;
      esac
      shift 2
      ;;
    --help)
      usage
      ;;
    # If the argument is not a recognized flag, we assume it's the subcommand.
    *)
      break
      ;;
  esac
done

# If no arguments are left, it means no subcommand was provided.
if [ -z "$1" ]; then
  usage
fi

# The first remaining argument is the subcommand.
SUBCOMMAND="$1"
PLUGIN_SCRIPT="$PLUGIN_DIR/$SUBCOMMAND"

# Check if the plugin script exists and is executable.
if [ -x "$PLUGIN_SCRIPT" ]; then
  shift
  exec "$PLUGIN_SCRIPT" "$@"
else
  die "Unknown command '$SUBCOMMAND'. Run 'fc --help' to see a list of available commands."
fi
