#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         bin/circus-update
#
# DESCRIPTION:  This script is designed to be run automatically by a launchd
#               agent to keep the system up-to-date. It updates the dotfiles
#               repository and all Homebrew packages.
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the centralized initialization script to set up the environment.
# We need to find the root of the repo from this script's location.
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/init.sh"

# --- Configuration ----------------------------------------------------------
# Set the log file path for this script's output. The helper library will use it.
export LOG_FILE_PATH="$HOME/.circus/logs/updater.log"
# Ensure the log directory exists.
mkdir -p "$(dirname "$LOG_FILE_PATH")"

# --- Main Logic -------------------------------------------------------------
main() {
  msg_info "Starting scheduled update process..."

  # --- 1. Update Dotfiles Repository ---
  msg_info "Updating the dotfiles repository..."
  if [ -d "$DOTFILES_ROOT/.git" ]; then
    cd "$DOTFILES_ROOT"
    git pull
    cd - >/dev/null # Go back to previous directory silently
  else
    msg_warning "Dotfiles repository not found at $DOTFILES_ROOT. Skipping."
  fi

  # --- 2. Update Homebrew ---
  msg_info "Updating Homebrew and upgrading packages..."
  if command -v brew >/dev/null 2>&1; then
    brew update
    brew upgrade
    brew cleanup
  else
    msg_warning "Homebrew command not found. Skipping."
  fi

  msg_success "Scheduled update process complete."
}

main "$@"
