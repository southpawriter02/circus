#!/usr/bin/env bash\n\n# ==============================================================================\n#\n# Stage 3: Homebrew Installation & Bundle\n#\n# This script installs Homebrew and then uses Brewfiles to install packages.\n# It supports a base Brewfile and a role-specific Brewfile for layered\n# application management.\n#\n# ==============================================================================\n\n#\n# Helper function to run `brew bundle install` for a given Brewfile.\n#\nrun_brew_bundle() {\n  local brewfile_path=\"$1\"\n  local brewfile_type=\"$2\"\n\n  if [ -f \"$brewfile_path\" ]; then\n    msg_info \"Installing packages from $brewfile_type Brewfile at $brewfile_path...\"\n    if [ \"$DRY_RUN_MODE\" = true ]; then\n      msg_info \"[Dry Run] Would run: brew bundle install --file=$brewfile_path\"\n    else\n      if brew bundle install --file=\"$brewfile_path\"; then\n        msg_success \"All packages from $brewfile_type Brewfile installed successfully.\"\n      else\n        msg_error \"An error occurred during \`brew bundle install\` for the $brewfile_type Brewfile.\"\n      fi\n    fi\n  else\n    msg_warning \"$brewfile_type Brewfile not found at $brewfile_path. Skipping.\"\n  fi\n}\n\nmain() {\n  msg_info \"Stage 3: Homebrew Installation & Bundle\"\n\n  # --- Homebrew Installation Check ---\n  if command -v brew >/dev/null 2>&1; then\n    msg_info \"Homebrew is already installed. Updating...\"\n    if [ \"$DRY_RUN_MODE\" = true ]; then\n      msg_info \"[Dry Run] Would run: brew update\"\n    else\n      brew update\n    fi\n  else\n    msg_info \"Homebrew not found. Installing...\"\n    if [ \"$DRY_RUN_MODE\" = true ]; then\n      msg_info \"[Dry Run] Would run the official Homebrew installation script.\"\n    else\n      /bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"\n      eval \"$(/opt/homebrew/bin/brew shellenv)\"\n    fi\n  fi\n\n  # --- Homebrew Bundle Installation ---\n  # 1. Install from the base Brewfile for all roles.\n  local base_brewfile_path=\"$DOTFILES_DIR/Brewfile\"\n  run_brew_bundle \"$base_brewfile_path\" \"base\"\n\n  # 2. If a role is specified, install from the role-specific Brewfile.\n  if [ -n \"$INSTALL_ROLE\" ]; then\n    local role_brewfile_path=\"$DOTFILES_DIR/roles/$INSTALL_ROLE/Brewfile\"\n    if [ -f \"$role_brewfile_path\" ]; then\n      run_brew_bundle \"$role_brewfile_path\" \"role-specific ($INSTALL_ROLE)\"\n    else\n      msg_info \"No role-specific Brewfile found for role \'$INSTALL_ROLE\'. Skipping.\"\n    fi\n  fi\n\n  msg_success \"Homebrew installation stage complete.\"\n}\n\nmain\n