#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc-encrypt
#
# DESCRIPTION:  Quick file/folder encryption using GPG or OpenSSL.
#               Provides password-based symmetric encryption for sensitive
#               files, folders, and text.
#
# USAGE:        fc encrypt <action> [path] [options]
#
# ACTIONS:
#   file        Encrypt a file with password (AES-256)
#               - Creates .gpg or .enc file alongside original
#               - Options: --delete (remove original), --output
#
#   decrypt     Decrypt an encrypted file
#               - Auto-detects GPG vs OpenSSL based on extension
#               - Strips .gpg/.enc/.asc extension for output filename
#
#   folder      Encrypt a folder as compressed archive
#               - Creates tar.gz of folder, then encrypts
#               - Output: foldername.tar.gz.gpg
#
#   text        Encrypt text from stdin or interactively
#               - Outputs armored (ASCII) encrypted text
#               - Automatically copies to clipboard
#
# OPTIONS:
#   --delete    Delete original file/folder after encryption
#   --keep      Keep original (default behavior)
#   --output    Specify custom output file path
#
# EXAMPLES:
#   fc encrypt file secrets.txt            # Encrypt a file
#   fc encrypt file passwords.json --delete # Encrypt and remove original
#   fc encrypt decrypt secrets.txt.gpg     # Decrypt
#   fc encrypt folder ~/Documents/private  # Encrypt entire folder
#   echo "API_KEY=xxx" | fc encrypt text   # Encrypt text from pipe
#   fc encrypt text                        # Interactive text encryption
#
# ENCRYPTION DETAILS:
#   GPG (preferred):
#     - Uses AES-256 cipher (very secure)
#     - Output: .gpg (binary) or .asc (armored/ASCII)
#     - Install: brew install gnupg
#
#   OpenSSL (fallback):
#     - Uses AES-256-CBC with PBKDF2
#     - Output: .enc (binary)
#     - Built into macOS
#
# RECOMMENDATIONS:
#   - Use --delete only after verifying encrypted file can be decrypted
#   - For sensitive files, use 'fc encrypt folder' to encrypt entire directories
#   - Remember your password! There is no recovery mechanism
#   - For sharing encrypted files, ensure recipient has GPG or OpenSSL
#
# DEPENDENCIES:
#   Required: tar (built-in to macOS)
#   Required: pbcopy (built-in to macOS)
#   Optional: gpg (brew install gnupg) - preferred
#   Fallback: openssl (built-in to macOS)
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the common initialization script for logging and error handling
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc encrypt <action> [path] [options]"
  echo ""
  msg_info "Encrypt and decrypt files using GPG (or OpenSSL as fallback)."
  echo ""
  msg_info "Actions:"
  echo "  file <path>       - Encrypt a file with password"
  echo "  decrypt <path>    - Decrypt an encrypted file"
  echo "  folder <path>     - Encrypt a folder as archive"
  echo "  text              - Encrypt text from stdin"
  echo ""
  msg_info "Options:"
  echo "  --delete          - Delete original after encryption"
  echo "  --keep            - Keep original (default)"
  echo "  --output <path>   - Specify output file path"
  echo ""
  msg_info "Examples:"
  echo "  fc encrypt file secrets.txt          # Encrypt file"
  echo "  fc encrypt decrypt secrets.txt.gpg   # Decrypt"
  echo "  fc encrypt folder ~/private --delete # Encrypt and remove"
  echo ""
  exit 0
}


# --- Helper Functions -------------------------------------------------------

# Check if GPG is available
has_gpg() {
  command -v gpg &>/dev/null
}

# Check if OpenSSL is available (fallback)
has_openssl() {
  command -v openssl &>/dev/null
}

# Get the encryption tool to use
get_encrypt_tool() {
  if has_gpg; then
    echo "gpg"
  elif has_openssl; then
    echo "openssl"
  else
    echo "none"
  fi
}

# --- Action Functions -------------------------------------------------------

# Encrypt a file
action_file() {
  local input_path="$1"
  local delete_original=false
  local output_path=""
  
  # Parse options
  shift || true
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --delete)
        delete_original=true
        shift
        ;;
      --output)
        output_path="$2"
        shift 2
        ;;
      --keep)
        delete_original=false
        shift
        ;;
      *)
        shift
        ;;
    esac
  done
  
  if [[ -z "$input_path" ]]; then
    die "Please provide a file to encrypt."
  fi
  
  if [[ ! -f "$input_path" ]]; then
    die "File not found: $input_path"
  fi
  
  local tool
  tool=$(get_encrypt_tool)
  
  if [[ "$tool" == "none" ]]; then
    die "No encryption tool available. Please install GPG: brew install gnupg"
  fi
  
  # Default output path
  if [[ -z "$output_path" ]]; then
    if [[ "$tool" == "gpg" ]]; then
      output_path="${input_path}.gpg"
    else
      output_path="${input_path}.enc"
    fi
  fi
  
  msg_info "Encrypting $input_path..."
  echo ""
  
  if [[ "$tool" == "gpg" ]]; then
    # GPG symmetric encryption with AES-256
    if gpg --symmetric --cipher-algo AES256 --output "$output_path" "$input_path"; then
      msg_success "Created: $output_path"
    else
      die "Encryption failed."
    fi
  else
    # OpenSSL fallback
    msg_info "Using OpenSSL (GPG not available)"
    if openssl enc -aes-256-cbc -salt -pbkdf2 -in "$input_path" -out "$output_path"; then
      msg_success "Created: $output_path"
    else
      die "Encryption failed."
    fi
  fi
  
  echo ""
  
  if $delete_original; then
    rm -f "$input_path"
    msg_success "Original file deleted."
  else
    msg_info "Original file preserved: $input_path"
  fi
}

# Decrypt a file
action_decrypt() {
  local input_path="$1"
  local output_path=""
  
  # Parse options
  shift || true
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --output)
        output_path="$2"
        shift 2
        ;;
      *)
        shift
        ;;
    esac
  done
  
  if [[ -z "$input_path" ]]; then
    die "Please provide a file to decrypt."
  fi
  
  if [[ ! -f "$input_path" ]]; then
    die "File not found: $input_path"
  fi
  
  # Detect tool based on file extension
  local tool="gpg"
  if [[ "$input_path" == *.enc ]]; then
    tool="openssl"
  fi
  
  # Default output path: strip encryption extension
  if [[ -z "$output_path" ]]; then
    output_path="${input_path%.gpg}"
    output_path="${output_path%.enc}"
    output_path="${output_path%.asc}"
    
    # If output would overwrite input, add .decrypted
    if [[ "$output_path" == "$input_path" ]]; then
      output_path="${input_path}.decrypted"
    fi
  fi
  
  msg_info "Decrypting $input_path..."
  echo ""
  
  if [[ "$tool" == "gpg" ]] && has_gpg; then
    if gpg --decrypt --output "$output_path" "$input_path" 2>/dev/null; then
      msg_success "Created: $output_path"
    else
      die "Decryption failed. Wrong password or corrupted file."
    fi
  elif has_openssl; then
    if openssl enc -d -aes-256-cbc -pbkdf2 -in "$input_path" -out "$output_path"; then
      msg_success "Created: $output_path"
    else
      die "Decryption failed. Wrong password or corrupted file."
    fi
  else
    die "No decryption tool available."
  fi
}

# Encrypt a folder
action_folder() {
  local input_path="$1"
  local delete_original=false
  local output_path=""
  
  # Parse options
  shift || true
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --delete)
        delete_original=true
        shift
        ;;
      --output)
        output_path="$2"
        shift 2
        ;;
      *)
        shift
        ;;
    esac
  done
  
  if [[ -z "$input_path" ]]; then
    die "Please provide a folder to encrypt."
  fi
  
  # Remove trailing slash
  input_path="${input_path%/}"
  
  if [[ ! -d "$input_path" ]]; then
    die "Folder not found: $input_path"
  fi
  
  local tool
  tool=$(get_encrypt_tool)
  
  if [[ "$tool" == "none" ]]; then
    die "No encryption tool available. Please install GPG: brew install gnupg"
  fi
  
  local folder_name
  folder_name=$(basename "$input_path")
  
  # Default output path
  if [[ -z "$output_path" ]]; then
    if [[ "$tool" == "gpg" ]]; then
      output_path="${folder_name}.tar.gz.gpg"
    else
      output_path="${folder_name}.tar.gz.enc"
    fi
  fi
  
  msg_info "Creating encrypted archive of $input_path..."
  echo ""
  
  local parent_dir
  parent_dir=$(dirname "$input_path")
  
  if [[ "$tool" == "gpg" ]]; then
    # Create tar.gz and encrypt in one pipeline
    if tar -czf - -C "$parent_dir" "$folder_name" | gpg --symmetric --cipher-algo AES256 --output "$output_path"; then
      local size
      size=$(du -h "$output_path" | cut -f1)
      msg_success "Created: $output_path ($size)"
    else
      die "Encryption failed."
    fi
  else
    # OpenSSL fallback
    if tar -czf - -C "$parent_dir" "$folder_name" | openssl enc -aes-256-cbc -salt -pbkdf2 -out "$output_path"; then
      local size
      size=$(du -h "$output_path" | cut -f1)
      msg_success "Created: $output_path ($size)"
    else
      die "Encryption failed."
    fi
  fi
  
  echo ""
  
  if $delete_original; then
    rm -rf "$input_path"
    msg_success "Original folder deleted."
  else
    msg_info "Original folder preserved: $input_path"
  fi
}

# Encrypt text from stdin
action_text() {
  local tool
  tool=$(get_encrypt_tool)
  
  if [[ "$tool" == "none" ]]; then
    die "No encryption tool available. Please install GPG: brew install gnupg"
  fi
  
  local text=""
  
  if [[ -t 0 ]]; then
    # Interactive mode
    msg_info "Enter text to encrypt (Ctrl+D when done):"
    text=$(cat)
  else
    # Piped input
    text=$(cat)
  fi
  
  if [[ -z "$text" ]]; then
    die "No text provided."
  fi
  
  echo ""
  msg_info "Encrypting text..."
  echo ""
  
  local encrypted
  
  if [[ "$tool" == "gpg" ]]; then
    encrypted=$(echo "$text" | gpg --symmetric --cipher-algo AES256 --armor 2>/dev/null)
  else
    encrypted=$(echo "$text" | openssl enc -aes-256-cbc -salt -pbkdf2 -base64)
  fi
  
  if [[ -z "$encrypted" ]]; then
    die "Encryption failed."
  fi
  
  echo "$encrypted"
  echo ""
  
  echo -n "$encrypted" | pbcopy
  msg_success "Encrypted text copied to clipboard."
}

# --- Main Logic -------------------------------------------------------------
main() {
  if [[ -z "$1" ]] || [[ "$1" == "--help" ]]; then
    usage
  fi

  local action="$1"
  shift

  case "$action" in
    file)
      action_file "$@"
      ;;
    decrypt)
      action_decrypt "$@"
      ;;
    folder)
      action_folder "$@"
      ;;
    text)
      action_text
      ;;
    *)
      die "Unknown action '$action'. Run 'fc fc-encrypt --help' for available actions."
      ;;
  esac
}

main "$@"
