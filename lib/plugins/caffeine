#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         caffeine
#
# DESCRIPTION:  A wrapper around the built-in `caffeinate` command to prevent
#               the system from sleeping. This is useful for long-running
#               tasks or presentations.
#
# ==============================================================================

# --- Setup ------------------------------------------------------------------
# Source the helper library to get the error handling and logging functions.
source "$(dirname "${BASH_SOURCE[0]}")/../lib/helpers.sh"

# The directory where we store state files like PIDs.
readonly STATE_DIR="$HOME/.circus"
# The file where we store the process ID (PID) of the background caffeinate process.
readonly PID_FILE="$STATE_DIR/caffeinate.pid"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc caffeine <action> [duration]"
  echo ""
  msg_info "Prevents the system from sleeping."
  echo ""
  msg_info "Actions:"
  echo "  on        - Prevent sleep indefinitely. Runs in the background."
  echo "  off       - Allow the system to sleep again."
  echo "  for [min] - Prevent sleep for a specific number of minutes."
  echo "  status    - Check if caffeine is currently active."
  echo ""
  exit 0
}

# --- Main Logic -------------------------------------------------------------
main() {
  if [ -z "$1" ] || [ "$1" == "--help" ]; then
    usage
  fi

  ACTION="$1"

  case "$ACTION" in
    on)
      if [ -f "$PID_FILE" ]; then
        msg_warning "Caffeine is already active. Run 'fc caffeine off' to disable it."
        exit 0
      fi
      msg_info "Preventing sleep indefinitely. Run 'fc caffeine off' to restore normal behavior."
      # Ensure the state directory exists.
      mkdir -p "$STATE_DIR"
      # -d: Prevent display sleep, -i: Prevent system idle sleep, -s: Prevent disk idle sleep
      caffeinate -dis & 
      # Save the PID of the background process to our file.
      echo $! > "$PID_FILE"
      msg_success "Caffeine is now ON."
      ;;
    off)
      if [ ! -f "$PID_FILE" ]; then
        msg_warning "Caffeine is not currently active."
        exit 0
      fi
      msg_info "Allowing the system to sleep normally again..."
      # Read the PID from the file and kill the process.
      kill "$(cat "$PID_FILE")"
      rm "$PID_FILE"
      msg_success "Caffeine is now OFF."
      ;;
    for)
      if [ -z "$2" ]; then
        die "Please provide a duration in minutes."
      fi
      local minutes="$2"
      local seconds=$((minutes * 60))
      msg_info "Preventing sleep for $minutes minutes..."
      # -t: Specifies the timeout in seconds.
      caffeinate -dit "$seconds"
      msg_success "Caffeine will remain active for $minutes minutes."
      ;;
    status)
      if [ -f "$PID_FILE" ]; then
        msg_success "Caffeine is ON (preventing sleep indefinitely). PID: $(cat "$PID_FILE")"
      else
        msg_warning "Caffeine is OFF."
      fi
      ;;
    *)
      die "Unknown action '$ACTION'. Run 'fc caffeine --help' for available actions."
      ;;
  esac
}

main "$@"
