#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc-profile
#
# DESCRIPTION:  Manage dotfile profiles for the Dotfiles Flying Circus.
#               Provides commands to list, view current, and switch between
#               different dotfile profiles (e.g., work vs personal).
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Configuration -----------------------------------------------------------

readonly PROFILES_DIR="$DOTFILES_ROOT/profiles"
readonly BASE_PROFILE_DIR="$PROFILES_DIR/base"
readonly PROFILE_STATE_FILE="$HOME/.config/circus/current_profile"
readonly ROLES_DIR="$DOTFILES_ROOT/roles"
readonly ROLE_ENV_FILE="$HOME/.circus/role_env.sh"

# --- Usage Information -------------------------------------------------------

usage() {
  msg_info "Usage: fc profile <subcommand>"
  echo ""
  msg_info "Manage dotfile profiles for environment-specific configurations."
  echo ""
  msg_info "Subcommands:"
  echo "  list              - List available profiles"
  echo "  current           - Show the current active profile"
  echo "  switch <profile>  - Switch to a different profile"
  echo "  create [name]     - Create a new profile (interactive wizard)"
  echo ""
  msg_info "Examples:"
  echo "  fc profile list"
  echo "  fc profile current"
  echo "  fc profile switch work"
  echo "  fc profile create        # Interactive wizard"
  echo "  fc profile create client # Create 'client' profile"
  exit 0
}

# --- Helper Functions -------------------------------------------------------

#
# @description Get list of available profiles (directories in profiles/ except base)
#
get_available_profiles() {
  local profiles=()
  for dir in "$PROFILES_DIR"/*/; do
    [ -d "$dir" ] || continue
    local name
    name=$(basename "$dir")
    # Skip 'base' - it's not a switchable profile
    [ "$name" = "base" ] && continue
    profiles+=("$name")
  done
  printf '%s\n' "${profiles[@]}"
}

#
# @description Get the current active profile from state file
#
get_current_profile() {
  if [ -f "$PROFILE_STATE_FILE" ]; then
    cat "$PROFILE_STATE_FILE"
  else
    echo "none"
  fi
}

#
# @description Set the current profile in state file
#
set_current_profile() {
  local profile="$1"
  mkdir -p "$(dirname "$PROFILE_STATE_FILE")"
  echo "$profile" > "$PROFILE_STATE_FILE"
}

#
# @description Create a symlink with backup of existing file
#
symlink_with_backup() {
  local source="$1"
  local dest="$2"

  # If destination exists and is not a symlink, back it up
  if [ -e "$dest" ] && [ ! -L "$dest" ]; then
    local backup_path="${dest}.backup-$(date +%Y%m%d%H%M%S)"
    msg_info "  Backing up existing file to $(basename "$backup_path")"
    mv "$dest" "$backup_path"
  fi

  # Remove existing symlink if present
  [ -L "$dest" ] && rm "$dest"

  # Create symlink
  ln -s "$source" "$dest"
}

#
# @description Check if a role directory exists
#
role_exists() {
  local role="$1"
  [[ -d "$ROLES_DIR/$role" ]]
}

#
# @description Generate the role environment file
# This consolidates all env and alias files from the role directory into a single
# sourceable file for shell initialization.
#
generate_role_env() {
  local role="$1"
  local role_dir="$ROLES_DIR/$role"

  # Ensure circus directory exists
  mkdir -p "$(dirname "$ROLE_ENV_FILE")"

  # Create header
  cat > "$ROLE_ENV_FILE" << EOF
# ==============================================================================
# Role Environment File
# Auto-generated by: fc profile switch
# Role: $role
# Generated: $(date)
#
# DO NOT EDIT - this file is regenerated on profile switch
# To customize, edit files in: $role_dir/env/ and $role_dir/aliases/
# ==============================================================================

EOF

  local has_content=false

  # Append all env files from role
  if [[ -d "$role_dir/env" ]]; then
    for env_file in "$role_dir/env/"*.sh "$role_dir/env/"*.env.sh; do
      [[ -f "$env_file" ]] || continue
      has_content=true
      echo "" >> "$ROLE_ENV_FILE"
      echo "# --- $(basename "$env_file") ---" >> "$ROLE_ENV_FILE"
      cat "$env_file" >> "$ROLE_ENV_FILE"
    done
  fi

  # Append all alias files from role
  if [[ -d "$role_dir/aliases" ]]; then
    for alias_file in "$role_dir/aliases/"*.sh "$role_dir/aliases/"*.aliases.sh; do
      [[ -f "$alias_file" ]] || continue
      has_content=true
      echo "" >> "$ROLE_ENV_FILE"
      echo "# --- $(basename "$alias_file") ---" >> "$ROLE_ENV_FILE"
      cat "$alias_file" >> "$ROLE_ENV_FILE"
    done
  fi

  # Add role tracking variable
  echo "" >> "$ROLE_ENV_FILE"
  echo "# --- Role Tracking ---" >> "$ROLE_ENV_FILE"
  echo "export FC_ACTIVE_ROLE=\"$role\"" >> "$ROLE_ENV_FILE"

  chmod 600 "$ROLE_ENV_FILE"

  if $has_content; then
    return 0
  else
    return 1
  fi
}

# --- Command Logic -----------------------------------------------------------

do_list() {
  msg_info "Available profiles:"
  echo ""

  local profiles
  profiles=$(get_available_profiles)

  if [ -z "$profiles" ]; then
    echo "  (no profiles found)"
    echo ""
    msg_info "Create a profile by adding a directory to profiles/"
    msg_info "Example: mkdir -p $PROFILES_DIR/work"
    return 0
  fi

  local current
  current=$(get_current_profile)

  while IFS= read -r profile; do
    if [ "$profile" = "$current" ]; then
      echo "  * $profile (active)"
    else
      echo "    $profile"
    fi
  done <<< "$profiles"

  echo ""
  msg_info "Use 'fc fc-profile switch <name>' to switch profiles."
}

do_current() {
  local current
  current=$(get_current_profile)

  if [ "$current" = "none" ]; then
    msg_info "No profile is currently active."
    msg_info "Only base dotfiles are in use."
    msg_info ""
    msg_info "Use 'fc fc-profile list' to see available profiles."
  else
    msg_info "Current profile: $current"

    # Show what files this profile provides
    local profile_dir="$PROFILES_DIR/$current"
    if [ -d "$profile_dir" ]; then
      local files
      files=$(find "$profile_dir" -type f -name ".*" -o -type f ! -name ".*" 2>/dev/null | head -10)
      if [ -n "$files" ]; then
        echo ""
        msg_info "Profile overrides:"
        while IFS= read -r file; do
          echo "  - $(basename "$file")"
        done <<< "$files"
      fi
    fi
  fi
}

do_switch() {
  local target_profile="$1"

  if [ -z "$target_profile" ]; then
    die "Usage: fc fc-profile switch <profile>\n\nRun 'fc fc-profile list' to see available profiles."
  fi

  local profile_dir="$PROFILES_DIR/$target_profile"

  # Validate profile exists
  if [ ! -d "$profile_dir" ]; then
    die "Profile not found: $target_profile\n\nRun 'fc fc-profile list' to see available profiles."
  fi

  local current
  current=$(get_current_profile)

  if [ "$current" = "$target_profile" ]; then
    msg_info "Profile '$target_profile' is already active."
    return 0
  fi

  msg_info "Switching to profile: $target_profile"
  echo ""

  # Step 1: Apply base profile dotfiles
  msg_info "Applying base profile..."

  for subdir in "$BASE_PROFILE_DIR"/*/; do
    [ -d "$subdir" ] || continue
    local subdir_name
    subdir_name=$(basename "$subdir")

    # Skip oh-my-zsh-custom (handled separately)
    [[ "$subdir_name" == "oh-my-zsh-custom" ]] && continue

    for file in "$subdir"/.*; do
      [ -f "$file" ] || continue
      local filename
      filename=$(basename "$file")

      # Skip . and ..
      [[ "$filename" == "." || "$filename" == ".." ]] && continue

      local home_path="$HOME/$filename"
      echo "  [base] $filename"
      symlink_with_backup "$file" "$home_path"
    done
  done

  # Handle zsh/zshrc.symlink specially
  local zshrc_source="$BASE_PROFILE_DIR/zsh/zshrc.symlink"
  if [ -f "$zshrc_source" ]; then
    echo "  [base] .zshrc"
    symlink_with_backup "$zshrc_source" "$HOME/.zshrc"
  fi

  echo ""

  # Step 2: Apply profile-specific overrides
  msg_info "Applying $target_profile profile overrides..."

  local has_overrides=false
  for file in "$profile_dir"/.*  "$profile_dir"/*; do
    [ -f "$file" ] || continue
    local filename
    filename=$(basename "$file")

    # Skip . and ..
    [[ "$filename" == "." || "$filename" == ".." ]] && continue

    has_overrides=true
    local home_path="$HOME/$filename"
    echo "  [override] $filename"
    symlink_with_backup "$file" "$home_path"
  done

  if [ "$has_overrides" = false ]; then
    echo "  (no overrides in this profile)"
  fi

  echo ""

  # Step 3: Generate role environment file if role exists
  # Profile names often match role names (developer, work, personal)
  if role_exists "$target_profile"; then
    msg_info "Generating role environment for: $target_profile"

    if generate_role_env "$target_profile"; then
      local env_count alias_count
      env_count=$(find "$ROLES_DIR/$target_profile/env" -name "*.sh" 2>/dev/null | wc -l | tr -d ' ')
      alias_count=$(find "$ROLES_DIR/$target_profile/aliases" -name "*.sh" 2>/dev/null | wc -l | tr -d ' ')
      echo "  Loaded $env_count env files, $alias_count alias files"
      echo "  Generated: $ROLE_ENV_FILE"
    else
      echo "  (no env/alias files found for this role)"
    fi
    echo ""
  fi

  # Save state
  set_current_profile "$target_profile"

  msg_success "Profile switched to: $target_profile"
  echo ""
  msg_info "Next steps:"
  echo "  - Restart your shell or run: source ~/.zshrc"
  if [[ -f "$ROLE_ENV_FILE" ]]; then
    echo "  - Role env will be auto-loaded if ~/.zshrc sources ~/.circus/role_env.sh"
  fi
}

do_create() {
  local profile_name="$1"
  
  echo ""
  msg_info "╔════════════════════════════════════════╗"
  msg_info "║   Interactive Profile Creation Wizard  ║"
  msg_info "╚════════════════════════════════════════╝"
  echo ""
  
  # Step 1: Get profile name
  if [[ -z "$profile_name" ]]; then
    msg_info "Step 1/4: Profile Name"
    echo ""
    echo "  What would you like to call this profile?"
    echo "  Examples: work, personal, client, freelance"
    echo ""
    read -rp "  Profile name: " profile_name
    
    if [[ -z "$profile_name" ]]; then
      die "Profile name is required."
    fi
  else
    msg_info "Creating profile: $profile_name"
  fi
  
  # Validate name
  if [[ ! "$profile_name" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
    die "Invalid profile name. Use letters, numbers, hyphens, and underscores only."
  fi
  
  local profile_dir="$PROFILES_DIR/$profile_name"
  
  if [[ -d "$profile_dir" ]]; then
    die "Profile '$profile_name' already exists at $profile_dir"
  fi
  
  echo ""
  
  # Step 2: Profile description
  msg_info "Step 2/4: Description"
  echo ""
  echo "  Briefly describe this profile (optional):"
  read -rp "  Description: " profile_desc
  
  echo ""
  
  # Step 3: Select components to include
  msg_info "Step 3/4: Components"
  echo ""
  echo "  Which configuration files would you like to customize?"
  echo ""
  
  local include_git=false
  local include_ssh=false
  local include_shell=false
  local include_editor=false
  
  # Use fzf if available for multi-select
  if command -v fzf &>/dev/null; then
    local components
    components=$(printf '%s\n' \
      "git       - Git configuration (.gitconfig)" \
      "ssh       - SSH configuration (.ssh/config)" \
      "shell     - Shell aliases and functions" \
      "editor    - Editor settings (VSCode, JetBrains)" | \
      fzf --multi --height=40% --layout=reverse --border=rounded \
          --prompt="Select components (TAB to multi-select): " \
          --header="Press TAB to select, Enter when done")
    
    [[ "$components" == *"git"* ]] && include_git=true
    [[ "$components" == *"ssh"* ]] && include_ssh=true
    [[ "$components" == *"shell"* ]] && include_shell=true
    [[ "$components" == *"editor"* ]] && include_editor=true
  else
    # Fallback to manual selection
    read -rp "  Include Git config? [y/N] " ans
    [[ "$ans" =~ ^[Yy] ]] && include_git=true
    
    read -rp "  Include SSH config? [y/N] " ans
    [[ "$ans" =~ ^[Yy] ]] && include_ssh=true
    
    read -rp "  Include shell customizations? [y/N] " ans
    [[ "$ans" =~ ^[Yy] ]] && include_shell=true
    
    read -rp "  Include editor settings? [y/N] " ans
    [[ "$ans" =~ ^[Yy] ]] && include_editor=true
  fi
  
  echo ""
  
  # Step 4: Confirmation
  msg_info "Step 4/4: Confirmation"
  echo ""
  echo "  Profile name:  $profile_name"
  [[ -n "$profile_desc" ]] && echo "  Description:   $profile_desc"
  echo "  Location:      $profile_dir"
  echo ""
  echo "  Components:"
  [[ "$include_git" == true ]] && echo "    ✓ Git configuration"
  [[ "$include_ssh" == true ]] && echo "    ✓ SSH configuration"
  [[ "$include_shell" == true ]] && echo "    ✓ Shell customizations"
  [[ "$include_editor" == true ]] && echo "    ✓ Editor settings"
  [[ "$include_git" == false && "$include_ssh" == false && "$include_shell" == false && "$include_editor" == false ]] && \
    echo "    (none selected - empty profile)"
  echo ""
  
  read -rp "  Create this profile? [Y/n] " confirm
  if [[ "$confirm" =~ ^[Nn] ]]; then
    msg_info "Cancelled."
    return 0
  fi
  
  # Create the profile
  echo ""
  msg_info "Creating profile..."
  
  mkdir -p "$profile_dir"
  
  # Create README
  cat > "$profile_dir/README.md" << EOF
# Profile: $profile_name

${profile_desc:-No description provided.}

## Created

$(date +%Y-%m-%d)

## Usage

\`\`\`bash
fc profile switch $profile_name
\`\`\`

## Files

Add your profile-specific dotfiles here. Files will override base profile.
EOF
  
  # Create component templates
  if [[ "$include_git" == true ]]; then
    cat > "$profile_dir/.gitconfig" << 'EOF'
# Profile-specific Git configuration
# This overrides the base .gitconfig

[user]
    # name = Your Name
    # email = your.email@example.com

[core]
    # Add profile-specific settings here
EOF
    echo "  Created .gitconfig"
  fi
  
  if [[ "$include_ssh" == true ]]; then
    mkdir -p "$profile_dir/.ssh"
    cat > "$profile_dir/.ssh/config" << 'EOF'
# Profile-specific SSH configuration

# Example:
# Host work-server
#     HostName server.work.com
#     User your-username
#     IdentityFile ~/.ssh/work_key
EOF
    echo "  Created .ssh/config"
  fi
  
  if [[ "$include_shell" == true ]]; then
    cat > "$profile_dir/.aliases" << 'EOF'
# Profile-specific shell aliases

# Example:
# alias proj="cd ~/Work/Projects"
# alias vpn="networksetup -connectpppoeservice 'Work VPN'"
EOF
    echo "  Created .aliases"
  fi
  
  if [[ "$include_editor" == true ]]; then
    mkdir -p "$profile_dir/.config/Code/User"
    cat > "$profile_dir/.config/Code/User/settings.json" << 'EOF'
{
  // Profile-specific VSCode settings
  // These override base settings
}
EOF
    echo "  Created VSCode settings"
  fi
  
  echo ""
  msg_success "Profile '$profile_name' created successfully!"
  echo ""
  msg_info "Next steps:"
  echo "  1. Edit files in: $profile_dir"
  echo "  2. Switch to profile: fc profile switch $profile_name"
  echo ""
}

# --- Main Dispatcher ---------------------------------------------------------

main() {
  if [ -z "$1" ] || [ "$1" == "--help" ]; then
    usage
  fi

  local subcommand="$1"
  shift

  case "$subcommand" in
    list)
      do_list
      ;;
    current)
      do_current
      ;;
    switch)
      do_switch "$@"
      ;;
    create)
      do_create "$@"
      ;;
    *)
      die "Unknown subcommand: $subcommand. Run 'fc profile --help' for usage."
      ;;
  esac
}

main "$@"
