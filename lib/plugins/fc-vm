#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc-vm
#
# DESCRIPTION:  Manages container virtual machines using Lima or Colima.
#               Provides a unified interface for starting, stopping, and
#               managing development VMs on macOS.
#
# REQUIRES:
#   - macOS 12.0 or later
#   - lima (limactl) OR colima installed via Homebrew
#
# DEPENDENCIES:
#   - Homebrew: brew install lima  OR  brew install colima docker
#   - No sudo required for normal operations
#
# REFERENCES:
#   - https://lima-vm.io/
#   - https://github.com/abiosoft/colima
#
# ACTIONS:
#   list      - List all VMs with their status
#   start     - Start a VM (default VM if no name specified)
#   stop      - Stop a VM gracefully
#   status    - Show detailed VM status
#   shell     - Open a shell inside the VM
#   delete    - Delete a VM (with confirmation)
#   create    - Create a new VM
#   ip        - Show the IP address of a VM
#   provider  - Show or set the active provider
#
# EXAMPLES:
#   fc vm list              # List all VMs
#   fc vm start             # Start the default VM
#   fc vm start myvm        # Start a specific VM
#   fc vm stop              # Stop the default VM
#   fc vm shell             # Open shell in default VM
#   fc vm status myvm       # Show status of specific VM
#   fc vm provider          # Show current provider
#   fc vm provider colima   # Switch to Colima provider
#
# NOTES:
#   - Provider auto-detection: Colima preferred if both installed
#   - Configuration stored in ~/.config/circus/vm.conf
#   - Lima uses "instances", Colima uses "profiles" (unified as "VMs" here)
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Configuration ----------------------------------------------------------
readonly VM_CONFIG_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/circus/vm.conf"
readonly VM_BACKENDS_DIR="${CIRCUS_DIR:-$HOME/.dotfiles}/lib/vm_backends"

# --- Help and Usage ---------------------------------------------------------

usage() {
    msg_info "Usage: fc vm <action> [name]"
    echo ""
    msg_info "Manages container VMs (Lima or Colima) from the command line."
    echo ""
    msg_info "Actions:"
    echo "  list              List all VMs with their status"
    echo "  start [name]      Start a VM (default VM if no name)"
    echo "  stop [name]       Stop a VM gracefully"
    echo "  status [name]     Show detailed VM status"
    echo "  shell [name]      Open a shell inside the VM"
    echo "  delete <name>     Delete a VM (requires confirmation)"
    echo "  create <name>     Create a new VM"
    echo "  ip [name]         Show the IP address of a VM"
    echo "  provider [name]   Show or set the active provider (lima/colima)"
    echo ""
    msg_info "Examples:"
    echo "  fc vm list                  # List all VMs"
    echo "  fc vm start                 # Start the default VM"
    echo "  fc vm start myvm            # Start a named VM"
    echo "  fc vm shell                 # SSH into default VM"
    echo "  fc vm provider colima       # Use Colima as provider"
    echo ""
    exit 0
}

# --- Helper Functions -------------------------------------------------------

# Load configuration file if it exists
load_config() {
    if [[ -f "$VM_CONFIG_FILE" ]]; then
        # shellcheck source=/dev/null
        source "$VM_CONFIG_FILE"
    fi
}

# Save configuration
save_config() {
    local config_dir
    config_dir=$(dirname "$VM_CONFIG_FILE")
    
    if [[ ! -d "$config_dir" ]]; then
        mkdir -p "$config_dir"
    fi
    
    cat > "$VM_CONFIG_FILE" << EOF
# VM Provider Configuration
# Generated by fc vm

# Provider: lima or colima
VM_PROVIDER="${VM_PROVIDER:-}"

# Default VM name (optional)
VM_DEFAULT_NAME="${VM_DEFAULT_NAME:-default}"
EOF
    
    msg_debug "Configuration saved to $VM_CONFIG_FILE"
}

# Auto-detect available provider
detect_provider() {
    # Prefer Colima if both are installed (more common for Docker users)
    if command -v colima &>/dev/null; then
        echo "colima"
    elif command -v limactl &>/dev/null; then
        echo "lima"
    else
        echo ""
    fi
}

# Get the active provider
get_provider() {
    load_config
    
    # Use configured provider if set and available
    if [[ -n "${VM_PROVIDER:-}" ]]; then
        case "$VM_PROVIDER" in
            lima)
                if command -v limactl &>/dev/null; then
                    echo "lima"
                    return
                fi
                ;;
            colima)
                if command -v colima &>/dev/null; then
                    echo "colima"
                    return
                fi
                ;;
        esac
    fi
    
    # Fall back to auto-detection
    detect_provider
}

# Load the provider backend
load_provider() {
    local provider
    provider=$(get_provider)
    
    if [[ -z "$provider" ]]; then
        die "No VM provider found. Install Lima or Colima:\n  brew install lima\n  brew install colima docker"
    fi
    
    local backend_file="${VM_BACKENDS_DIR}/vm_${provider}.sh"
    
    if [[ ! -f "$backend_file" ]]; then
        die "Provider backend not found: $backend_file"
    fi
    
    # shellcheck source=/dev/null
    source "$backend_file"
    
    echo "$provider"
}

# --- Action Handlers --------------------------------------------------------

# List all VMs
action_list() {
    local provider
    provider=$(load_provider)
    
    msg_info "Listing VMs (provider: $provider)"
    echo ""
    
    "vm_${provider}_list_pretty"
}

# Start a VM
action_start() {
    local name="$1"
    local provider
    provider=$(load_provider)
    
    "vm_${provider}_start" "$name"
}

# Stop a VM
action_stop() {
    local name="$1"
    local provider
    provider=$(load_provider)
    
    "vm_${provider}_stop" "$name"
}

# Get VM status
action_status() {
    local name="$1"
    local provider
    provider=$(load_provider)
    
    "vm_${provider}_status" "$name"
}

# Open shell in VM
action_shell() {
    local name="$1"
    local provider
    provider=$(load_provider)
    
    "vm_${provider}_shell" "$name"
}

# Delete a VM
action_delete() {
    local name="$1"
    
    if [[ -z "$name" ]]; then
        die "VM name required. Usage: fc vm delete <name>"
    fi
    
    local provider
    provider=$(load_provider)
    
    "vm_${provider}_delete" "$name"
}

# Create a new VM
action_create() {
    local name="$1"
    local template="$2"
    
    if [[ -z "$name" ]]; then
        die "VM name required. Usage: fc vm create <name> [template]"
    fi
    
    local provider
    provider=$(load_provider)
    
    "vm_${provider}_create" "$name" "$template"
}

# Get VM IP address
action_ip() {
    local name="$1"
    local provider
    provider=$(load_provider)
    
    "vm_${provider}_ip" "$name"
}

# Show or set provider
action_provider() {
    local new_provider="$1"
    
    if [[ -z "$new_provider" ]]; then
        # Show current provider
        local current
        current=$(get_provider)
        
        if [[ -z "$current" ]]; then
            msg_warning "No VM provider installed"
            echo ""
            msg_info "Install a provider:"
            echo "  brew install lima       # For Lima VMs"
            echo "  brew install colima     # For Docker/Kubernetes"
        else
            msg_info "Current provider: $current"
            echo ""
            
            # Show what's available
            msg_info "Available providers:"
            if command -v limactl &>/dev/null; then
                echo "  lima (limactl) $(limactl --version 2>/dev/null | head -1)"
            else
                echo "  lima (not installed)"
            fi
            if command -v colima &>/dev/null; then
                echo "  colima $(colima version 2>/dev/null | head -1)"
            else
                echo "  colima (not installed)"
            fi
        fi
    else
        # Set provider
        case "$new_provider" in
            lima)
                if ! command -v limactl &>/dev/null; then
                    die "Lima is not installed. Run: brew install lima"
                fi
                VM_PROVIDER="lima"
                save_config
                msg_success "Provider set to: lima"
                ;;
            colima)
                if ! command -v colima &>/dev/null; then
                    die "Colima is not installed. Run: brew install colima"
                fi
                VM_PROVIDER="colima"
                save_config
                msg_success "Provider set to: colima"
                ;;
            *)
                die "Unknown provider: $new_provider. Available: lima, colima"
                ;;
        esac
    fi
}

# --- Main Logic -------------------------------------------------------------

main() {
    if [[ -z "$1" ]] || [[ "$1" == "--help" ]]; then
        usage
    fi
    
    local action="$1"
    shift
    
    case "$action" in
        list)
            action_list
            ;;
        start)
            action_start "$1"
            ;;
        stop)
            action_stop "$1"
            ;;
        status)
            action_status "$1"
            ;;
        shell)
            action_shell "$1"
            ;;
        delete)
            action_delete "$1"
            ;;
        create)
            action_create "$1" "$2"
            ;;
        ip)
            action_ip "$1"
            ;;
        provider)
            action_provider "$1"
            ;;
        *)
            die "Unknown action '$action'. Run 'fc vm --help' for available actions."
            ;;
    esac
}

main "$@"
