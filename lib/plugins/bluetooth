#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         bluetooth
#
# DESCRIPTION:  This command manages the system's Bluetooth adapter.
#
# ==============================================================================

# --- Setup ------------------------------------------------------------------
# Source the helper library to get the error handling and logging functions.
source "$(dirname "${BASH_SOURCE[0]}")/../lib/helpers.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc bluetooth <action>"
  echo ""
  msg_info "Manages the system's Bluetooth adapter."
  echo ""
  msg_info "Actions:"
  echo "  on      - Turn Bluetooth on."
  echo "  off     - Turn Bluetooth off."
  echo "  status  - Show the current Bluetooth status."
  echo ""
  exit 0
}

# --- Main Logic -------------------------------------------------------------
main() {
  if [ -z "$1" ] || [ "$1" == "--help" ]; then
    usage
  fi

  # Dependency Check: Ensure blueutil is installed before proceeding.
  if ! command -v "blueutil" >/dev/null 2>&1; then
    die "The 'blueutil' command is required but not found. Please run the main installer."
  fi

  ACTION="$1"

  case "$ACTION" in
    on)
      msg_info "Turning Bluetooth on..."
      blueutil --power 1
      msg_success "Bluetooth is now on."
      ;;
    off)
      msg_info "Turning Bluetooth off..."
      blueutil --power 0
      msg_success "Bluetooth is now off."
      ;;
    status)
      msg_info "Checking Bluetooth status..."
      local power_state
      power_state=$(blueutil --power)
      if [ "$power_state" -eq 1 ]; then
        msg_success "Bluetooth is currently on."
      else
        msg_warning "Bluetooth is currently off."
      fi
      ;;
    *)
      die "Unknown action '$ACTION'. Run 'fc bluetooth --help' for available actions."
      ;;
  esac
}

main "$@"
