#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         doctor
#
# DESCRIPTION:  This plugin runs a series of diagnostic checks to ensure the
#               system is in a healthy and correctly configured state.
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the centralized initialization script to set up the environment.
source "$(dirname "${BASH_SOURCE[0]}")/../../lib/init.sh"

# --- Usage Information ---
usage() {
  ui_header "System Doctor"
  echo "Runs a series of diagnostic checks on your system."
  echo ""
  echo "Usage: fc doctor"
  exit 0
}

# --- Check Functions ---

check_brew() {
  ui_spinner_start "Checking Homebrew status..."

  if ! command -v brew >/dev/null 2>&1; then
    ui_spinner_stop "error" "Homebrew is not installed."
    return 1
  fi

  # We temporarily disable `set -e` because `brew doctor` can return a non-zero
  # exit code for warnings, which we want to handle gracefully.
  set +e
  local brew_output
  brew_output=$(brew doctor 2>&1)
  local brew_status=$?
  set -e

  if [ $brew_status -eq 0 ]; then
    ui_spinner_stop "success" "Homebrew is healthy."
  else
    ui_spinner_stop "warning" "Homebrew has issues."
    ui_notice "warning" "Brew Doctor Output:\n$brew_output"
  fi
}

check_critical_tools() {
  ui_header "Checking Critical Tools"
  local missing_tools=0
  local tools_to_check=("git" "zsh" "op" "shellcheck" "gpg")

  for tool in "${tools_to_check[@]}"; do
    if command -v "$tool" >/dev/null 2>&1; then
      ui_list_item "$tool" 2 "${UI_SUCCESS}${UI_ICON_SUCCESS}${UI_RESET}"
    else
      ui_list_item "$tool (Missing)" 2 "${UI_ERROR}${UI_ICON_ERROR}${UI_RESET}"
      ((missing_tools++))
    fi
  done

  if [ $missing_tools -gt 0 ]; then
    echo ""
    ui_notice "warning" "$missing_tools critical tool(s) are missing. Consider running the installer."
  else
    echo ""
    ui_list_item "All critical tools installed" 0 "${UI_SUCCESS}${UI_ICON_STAR}${UI_RESET}"
  fi
}

# --- Main Logic ---
main() {
  if [ "$1" == "--help" ]; then
    usage
  fi

  ui_header "System Health Check"

  check_brew

  check_critical_tools

  echo ""
}

main "$@"
