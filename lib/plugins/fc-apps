#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc-apps
#
# DESCRIPTION:  Manage application installations via system package manager.
#               Uses a Brewfile-compatible configuration for apps.
#
# CROSS-PLATFORM:
#   - macOS: Uses Homebrew and Mac App Store (mas)
#   - Linux: Uses apt/dnf/pacman based on distribution
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Configuration -----------------------------------------------------------

readonly APPS_CONFIG_FILE="$HOME/.config/circus/apps.conf"
readonly APPS_CONFIG_TEMPLATE="$DOTFILES_ROOT/lib/templates/apps.conf.template"

# --- Usage Information -------------------------------------------------------

usage() {
  msg_info "Usage: fc apps <subcommand> [options]"
  echo ""
  msg_info "Manage application installations via package manager."
  echo ""
  msg_info "Subcommands:"
  echo "  setup               - Create configuration file from template"
  echo "  list                - Show configured apps and their status"
  echo "  install             - Install all apps from configuration"
  echo "  add <name>          - Add and install a package"
  echo "  update              - Update all installed packages"
  echo "  search <name>       - Search for a package"
  if is_macos; then
    echo "  add --cask <name>   - Add and install a Homebrew cask"
    echo "  add --mas <n> <id>  - Add and install a Mac App Store app"
  fi
  echo ""
  msg_info "Examples:"
  echo "  fc apps setup"
  echo "  fc apps add git"
  echo "  fc apps update"
  echo "  fc apps search python"
  echo ""
  if is_linux; then
    local distro
    distro=$(detect_distro)
    msg_info "Linux ($distro): Uses $(os_get_package_manager)"
  fi
  exit 0
}

# --- Helper Functions -------------------------------------------------------

check_package_manager() {
  if is_macos; then
    local brew_cmd=${BREW_CMD:-brew}
    if ! command -v "$brew_cmd" >/dev/null 2>&1; then
      die "Homebrew is not installed. Please install it first: https://brew.sh"
    fi
  else
    local pm
    pm=$(os_get_package_manager)
    if [[ -z "$pm" ]]; then
      die "No supported package manager found (apt, dnf, or pacman required)"
    fi
  fi
}

has_config() {
  [ -f "$APPS_CONFIG_FILE" ]
}

# --- Command Logic -----------------------------------------------------------

do_setup() {
  local config_dir="$HOME/.config/circus"

  if has_config; then
    msg_info "Configuration file already exists: $APPS_CONFIG_FILE"
    echo ""
    msg_info "Edit it with: \$EDITOR $APPS_CONFIG_FILE"
    return 0
  fi

  if [ ! -f "$APPS_CONFIG_TEMPLATE" ]; then
    msg_info "Creating default configuration..."
    mkdir -p "$config_dir"
    
    if is_macos; then
      cat > "$APPS_CONFIG_FILE" << 'EOF'
# Circus Apps Configuration (macOS)
# Format: brew "name" or cask "name" or mas "name", id: 123456

# Example formulae:
# brew "git"
# brew "node"

# Example casks:
# cask "visual-studio-code"
# cask "docker"

# Example Mac App Store apps:
# mas "Xcode", id: 497799835
EOF
    else
      cat > "$APPS_CONFIG_FILE" << 'EOF'
# Circus Apps Configuration (Linux)
# List packages one per line

# Example packages:
# git
# nodejs
# docker.io
EOF
    fi
  else
    mkdir -p "$config_dir"
    cp "$APPS_CONFIG_TEMPLATE" "$APPS_CONFIG_FILE"
  fi

  msg_success "Configuration file created: $APPS_CONFIG_FILE"
  echo ""
  msg_info "Next steps:"
  msg_info "  1. Edit the config: \$EDITOR $APPS_CONFIG_FILE"
  msg_info "  2. Add packages you want to install"
  msg_info "  3. Run: fc apps install"
}

do_list() {
  check_package_manager
  
  msg_info "Installed Packages"
  echo "=================="
  echo ""
  
  if is_macos; then
    local brew_cmd=${BREW_CMD:-brew}
    msg_info "Homebrew Formulae:"
    "$brew_cmd" list --formula 2>/dev/null | head -20
    echo ""
    msg_info "Homebrew Casks:"
    "$brew_cmd" list --cask 2>/dev/null | head -20
  else
    local pm
    pm=$(os_get_package_manager)
    msg_info "Packages (via $pm):"
    case "$pm" in
      apt)
        dpkg --get-selections 2>/dev/null | grep -v deinstall | head -30
        ;;
      dnf)
        dnf list installed 2>/dev/null | head -30
        ;;
      pacman)
        pacman -Q 2>/dev/null | head -30
        ;;
    esac
  fi
  
  echo ""
  msg_info "(showing first 20-30 packages)"
}

do_install() {
  check_package_manager
  
  if has_config; then
    msg_info "Installing from configuration file..."
    
    if is_macos; then
      local brew_cmd=${BREW_CMD:-brew}
      if "$brew_cmd" bundle install --file="$APPS_CONFIG_FILE" --no-lock; then
        msg_success "Installation complete!"
      else
        msg_warning "Some packages may have failed to install."
      fi
    else
      local pm
      pm=$(os_get_package_manager)
      # Read non-comment, non-empty lines from config
      while IFS= read -r pkg || [[ -n "$pkg" ]]; do
        [[ -z "$pkg" || "$pkg" =~ ^# ]] && continue
        msg_info "Installing: $pkg"
        os_package_install "$pkg"
      done < "$APPS_CONFIG_FILE"
      msg_success "Installation complete!"
    fi
  else
    msg_info "No configuration file found."
    msg_info "Run 'fc apps setup' to create one."
  fi
}

do_add() {
  local pkg_type=""
  local pkg_name=""
  local mas_id=""
  
  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --brew)
        pkg_type="brew"
        shift
        pkg_name="${1:-}"
        shift
        ;;
      --cask)
        pkg_type="cask"
        shift
        pkg_name="${1:-}"
        shift
        ;;
      --mas)
        pkg_type="mas"
        shift
        pkg_name="${1:-}"
        shift
        mas_id="${1:-}"
        shift
        ;;
      *)
        if [[ -z "$pkg_name" ]]; then
          pkg_name="$1"
        fi
        shift
        ;;
    esac
  done
  
  if [[ -z "$pkg_name" ]]; then
    die "Package name required. Usage: fc apps add <package>"
  fi
  
  check_package_manager
  
  msg_info "Installing $pkg_name..."
  
  if is_macos; then
    local brew_cmd=${BREW_CMD:-brew}
    case "$pkg_type" in
      cask)
        "$brew_cmd" install --cask "$pkg_name" && msg_success "Installed: $pkg_name"
        ;;
      mas)
        if [[ -z "$mas_id" ]]; then
          die "Mac App Store ID required. Usage: fc apps add --mas \"Name\" 123456"
        fi
        local mas_cmd=${MAS_CMD:-mas}
        "$mas_cmd" install "$mas_id" && msg_success "Installed: $pkg_name"
        ;;
      *)
        "$brew_cmd" install "$pkg_name" && msg_success "Installed: $pkg_name"
        ;;
    esac
  else
    os_package_install "$pkg_name" && msg_success "Installed: $pkg_name"
  fi
}

do_update() {
  check_package_manager
  
  msg_info "Updating packages..."
  
  if is_macos; then
    local brew_cmd=${BREW_CMD:-brew}
    msg_info "Updating Homebrew..."
    "$brew_cmd" update && "$brew_cmd" upgrade
    msg_success "Homebrew packages updated!"
  else
    os_package_update
    msg_success "System packages updated!"
  fi
}

do_search() {
  local query="$1"
  
  if [[ -z "$query" ]]; then
    die "Search query required. Usage: fc apps search <name>"
  fi
  
  check_package_manager
  
  msg_info "Searching for: $query"
  echo ""
  
  if is_macos; then
    local brew_cmd=${BREW_CMD:-brew}
    "$brew_cmd" search "$query"
  else
    local pm
    pm=$(os_get_package_manager)
    case "$pm" in
      apt)
        apt-cache search "$query" | head -20
        ;;
      dnf)
        dnf search "$query" 2>/dev/null | head -20
        ;;
      pacman)
        pacman -Ss "$query" 2>/dev/null | head -20
        ;;
    esac
  fi
}

# --- Main Dispatcher ---------------------------------------------------------

main() {
  if [[ -z "${1:-}" ]] || [[ "$1" == "--help" ]]; then
    usage
  fi

  local subcommand="$1"
  shift

  case "$subcommand" in
    setup)
      do_setup
      ;;
    list)
      do_list
      ;;
    install)
      do_install
      ;;
    add)
      do_add "$@"
      ;;
    update)
      do_update
      ;;
    search)
      do_search "$@"
      ;;
    *)
      die "Unknown subcommand: $subcommand. Run 'fc apps --help' for usage."
      ;;
  esac
}

main "$@"
