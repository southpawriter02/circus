#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         backup
#
# DESCRIPTION:  This command backs up essential dotfiles to a specified
#               (and configurable) cloud or local directory.
#
# ==============================================================================

# --- Setup ------------------------------------------------------------------
set -e

# --- Help and Usage ---------------------------------------------------------
usage() {
  echo "Usage: fc backup"
  echo ""
  echo "Backs up essential dotfiles to a timestamped directory."
  echo "The backup location and the list of files to back up are configurable"
  echo "within this script."
  echo ""
  exit 1
}

# --- Main Logic -------------------------------------------------------------
main() {
  # --- Configuration --------------------------------------------------------

  # @description: The base directory where backups will be stored.
  # @customization: Change this to your preferred backup location.
  # Default is iCloud Drive. Examples for Dropbox and a local folder are below.
  local BACKUP_LOCATION_BASE="$HOME/Library/Mobile Documents/com~apple~CloudDocs/Backups"
  # local BACKUP_LOCATION_BASE="$HOME/Dropbox/Backups"
  # local BACKUP_LOCATION_BASE="$HOME/Documents/Backups"

  # @description: An array of files and directories to be backed up.
  # @customization: Add or remove items from this list.
  # Paths are relative to the user's home directory ($HOME).
  local DOTFILES_TO_BACKUP=(
    ".profile"
    ".bash_profile"
    ".bashrc"
    ".zprofile"
    ".zshrc"
    ".zshenv"
    ".gitconfig"
    ".config/htop"
  )

  # --- Backup Process -------------------------------------------------------

  echo "Starting dotfiles backup..."

  # Create the base backup directory if it doesn't exist.
  mkdir -p "$BACKUP_LOCATION_BASE"

  # Create a timestamped directory for this specific backup.
  local timestamp
  timestamp=$(date +%Y-%m-%d-%H%M%S)
  local backup_dir="$BACKUP_LOCATION_BASE/dotfiles-backup-$timestamp"
  mkdir -p "$backup_dir"

  echo "Backup destination: $backup_dir"

  # Loop through the list of dotfiles and back them up.
  for item in "${DOTFILES_TO_BACKUP[@]}"; do
    local source_path="$HOME/$item"
    if [ -e "$source_path" ]; then
      echo "Backing up '$item'..."
      # Use rsync to copy the file or directory.
      # -a: archive mode (preserves permissions, etc.)
      # -v: verbose
      # -h: human-readable
      rsync -avh "$source_path" "$backup_dir/"
    else
      echo "Skipping '$item' (does not exist)."
    fi
  done

  echo ""
  echo "Backup complete!"
}

#
# Execute the main function.
#
main "$@"
