#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         redis
#
# DESCRIPTION:  This command manages the Redis server, a key-value store
#               often used for development.
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the centralized initialization script to set up the environment.
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc redis <action>"
  echo ""
  msg_info "Manages the Redis server using Homebrew services."
  echo ""
  msg_info "Actions:"
  echo "  start    - Start the Redis server in the background."
  echo "  stop     - Stop the Redis server."
  echo "  restart  - Restart the Redis server."
  echo "  status   - Show the current status of the Redis service."
  echo "  update   - Update the Redis formula to the latest version."
  echo ""
  exit 0
}

# --- Main Logic -------------------------------------------------------------
main() {
  local brew_cmd=${BREW_CMD:-brew}

  if [ -z "$1" ] || [ "$1" == "--help" ]; then
    usage
  fi

  # Dependency Check: Ensure brew is installed before proceeding.
  if ! command -v "$brew_cmd" >/dev/null 2>&1; then
    die "The 'brew' command is required but not found. Please run the main installer."
  fi

  ACTION="$1"

  case "$ACTION" in
    start)
      msg_info "Starting Redis server..."
      "$brew_cmd" services start redis
      msg_success "Redis server started."
      ;;
    stop)
      msg_info "Stopping Redis server..."
      "$brew_cmd" services stop redis
      msg_success "Redis server stopped."
      ;;
    restart)
      msg_info "Restarting Redis server..."
      "$brew_cmd" services restart redis
      msg_success "Redis server restarted."
      ;;
    status)
      msg_info "Checking Redis service status..."
      # The `brew services list` command can be slow, so we grep to be specific.
      "$brew_cmd" services list | grep redis || msg_warning "Redis service not found or not running."
      ;;
    update)
      msg_info "Updating Redis formula..."
      "$brew_cmd" upgrade redis
      msg_success "Redis formula updated."
      ;;
    *)
      die "Unknown action '$ACTION'. Run 'fc redis --help' for available actions."
      ;;
  esac
}

main "$@"
