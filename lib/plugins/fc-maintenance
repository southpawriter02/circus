#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc-maintenance
#
# DESCRIPTION:  Run routine system maintenance and cleanup tasks.
#               Provides batch execution of common maintenance operations.
#
# CROSS-PLATFORM:
#   - macOS: Homebrew cache, Xcode DerivedData, DNS flush, Spotlight
#   - Linux: apt/dnf/pacman cache, journalctl, DNS resolvectl
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Configuration -----------------------------------------------------------

readonly MAINTENANCE_CONFIG_FILE="$HOME/.config/circus/maintenance.conf"

# Default configuration
TASK_PKG_CLEANUP=true
TASK_PKG_CACHE=true
TASK_NPM_CACHE=true
TASK_PIP_CACHE=true
TASK_USER_LOGS=true
TASK_SYSTEM_LOGS=false
TASK_DNS_FLUSH=false
TASK_TRASH=false
LOG_RETENTION_DAYS=7

# macOS-specific defaults
TASK_XCODE_DERIVED=true
TASK_SPOTLIGHT_REBUILD=false
TASK_DISK_VERIFY=false

# Load user configuration if it exists
if [ -f "$MAINTENANCE_CONFIG_FILE" ]; then
  # shellcheck source=/dev/null
  source "$MAINTENANCE_CONFIG_FILE"
fi

# --- Global Flags -----------------------------------------------------------
FLAG_DRY_RUN=false
FLAG_ALL=false
FLAG_INCLUDE_TRASH=false

# --- Usage Information -------------------------------------------------------

usage() {
  msg_info "Usage: fc maintenance [subcommand] [options]"
  echo ""
  msg_info "Run routine system maintenance and cleanup tasks."
  echo ""
  msg_info "Subcommands:"
  echo "  (none)              Run configured maintenance tasks"
  echo "  list                List all available maintenance tasks"
  echo "  run <task>          Run a specific maintenance task"
  echo ""
  msg_info "Options:"
  echo "  --all               Run all tasks"
  echo "  --include-trash     Include trash emptying"
  echo "  --dry-run           Show what would be done"
  echo ""
  msg_info "Available tasks:"
  echo "  pkg-cleanup         Clean up old package versions"
  echo "  pkg-cache           Clear package manager cache"
  echo "  npm-cache           Clear npm cache"
  echo "  pip-cache           Clear pip cache"
  echo "  user-logs           Clear old user log files"
  echo "  system-logs         Clear system logs (sudo)"
  echo "  dns-flush           Flush DNS cache"
  echo "  trash               Empty the Trash"
  if is_macos; then
    echo "  xcode-derived       Clear Xcode DerivedData"
    echo "  spotlight-rebuild   Rebuild Spotlight index (sudo)"
  fi
  echo ""
  exit 0
}

# --- Helper Functions -------------------------------------------------------

get_dir_size() {
  local dir="$1"
  if [ -d "$dir" ]; then
    du -sh "$dir" 2>/dev/null | cut -f1
  else
    echo "0B"
  fi
}

# --- Task Functions ---------------------------------------------------------

task_pkg_cleanup() {
  msg_info "Cleaning up old package versions..."
  
  if [ "$FLAG_DRY_RUN" = true ]; then
    msg_info "[DRY-RUN] Would run package cleanup"
    return 0
  fi
  
  if is_macos; then
    local brew_cmd=${BREW_CMD:-brew}
    if command -v "$brew_cmd" >/dev/null 2>&1; then
      "$brew_cmd" cleanup --prune=30
      msg_success "Homebrew cleanup complete."
    fi
  else
    local pm
    pm=$(os_get_package_manager 2>/dev/null)
    case "$pm" in
      apt)
        sudo apt autoremove -y 2>/dev/null
        msg_success "apt autoremove complete."
        ;;
      dnf)
        sudo dnf autoremove -y 2>/dev/null
        msg_success "dnf autoremove complete."
        ;;
      pacman)
        sudo pacman -Sc --noconfirm 2>/dev/null
        msg_success "pacman cleanup complete."
        ;;
    esac
  fi
}

task_pkg_cache() {
  msg_info "Clearing package manager cache..."
  
  if [ "$FLAG_DRY_RUN" = true ]; then
    msg_info "[DRY-RUN] Would clear package cache"
    return 0
  fi
  
  if is_macos; then
    local brew_cmd=${BREW_CMD:-brew}
    if command -v "$brew_cmd" >/dev/null 2>&1; then
      local cache_dir
      cache_dir=$("$brew_cmd" --cache 2>/dev/null)
      if [ -d "$cache_dir" ]; then
        local size
        size=$(get_dir_size "$cache_dir")
        msg_info "Clearing Homebrew cache ($size)..."
        rm -rf "${cache_dir:?}"/*
        msg_success "Homebrew cache cleared."
      fi
    fi
  else
    local pm
    pm=$(os_get_package_manager 2>/dev/null)
    case "$pm" in
      apt)
        sudo apt clean 2>/dev/null
        msg_success "apt cache cleared."
        ;;
      dnf)
        sudo dnf clean all 2>/dev/null
        msg_success "dnf cache cleared."
        ;;
      pacman)
        sudo pacman -Scc --noconfirm 2>/dev/null
        msg_success "pacman cache cleared."
        ;;
    esac
  fi
}

task_npm_cache() {
  if ! command -v npm >/dev/null 2>&1; then
    msg_info "npm not installed, skipping."
    return 0
  fi
  
  msg_info "Clearing npm cache..."
  
  if [ "$FLAG_DRY_RUN" = true ]; then
    msg_info "[DRY-RUN] Would run: npm cache clean --force"
    return 0
  fi
  
  npm cache clean --force 2>/dev/null
  msg_success "npm cache cleared."
}

task_pip_cache() {
  local cache_dir
  if is_macos; then
    cache_dir="$HOME/Library/Caches/pip"
  else
    cache_dir="$HOME/.cache/pip"
  fi
  
  if [ ! -d "$cache_dir" ]; then
    msg_info "pip cache not found, skipping."
    return 0
  fi
  
  local size
  size=$(get_dir_size "$cache_dir")
  msg_info "Clearing pip cache ($size)..."
  
  if [ "$FLAG_DRY_RUN" = true ]; then
    msg_info "[DRY-RUN] Would clear: $cache_dir"
    return 0
  fi
  
  rm -rf "${cache_dir:?}"/*
  msg_success "pip cache cleared."
}

task_xcode_derived() {
  if ! is_macos; then
    return 0
  fi
  
  local derived_dir="$HOME/Library/Developer/Xcode/DerivedData"
  
  if [ ! -d "$derived_dir" ]; then
    msg_info "Xcode DerivedData not found, skipping."
    return 0
  fi
  
  local size
  size=$(get_dir_size "$derived_dir")
  msg_info "Clearing Xcode DerivedData ($size)..."
  
  if [ "$FLAG_DRY_RUN" = true ]; then
    msg_info "[DRY-RUN] Would clear: $derived_dir"
    return 0
  fi
  
  rm -rf "${derived_dir:?}"/*
  msg_success "Xcode DerivedData cleared."
}

task_user_logs() {
  local logs_dir
  if is_macos; then
    logs_dir="$HOME/Library/Logs"
  else
    logs_dir="$HOME/.local/share"
  fi
  
  if [ ! -d "$logs_dir" ]; then
    msg_info "Logs directory not found, skipping."
    return 0
  fi
  
  msg_info "Clearing user logs older than $LOG_RETENTION_DAYS days..."
  
  if [ "$FLAG_DRY_RUN" = true ]; then
    local count
    count=$(find "$logs_dir" -type f -name "*.log" -mtime +"$LOG_RETENTION_DAYS" 2>/dev/null | wc -l | tr -d ' ')
    msg_info "[DRY-RUN] Would remove $count log files"
    return 0
  fi
  
  find "$logs_dir" -type f -name "*.log" -mtime +"$LOG_RETENTION_DAYS" -delete 2>/dev/null
  msg_success "Old user logs cleared."
}

task_system_logs() {
  msg_info "Clearing system logs (requires sudo)..."
  
  if [ "$FLAG_DRY_RUN" = true ]; then
    msg_info "[DRY-RUN] Would clear system logs"
    return 0
  fi
  
  if is_macos; then
    sudo rm -rf /var/log/*.log /var/log/*.gz 2>/dev/null
  else
    if command -v journalctl >/dev/null 2>&1; then
      sudo journalctl --vacuum-time=7d 2>/dev/null
    fi
    sudo rm -rf /var/log/*.log /var/log/*.gz 2>/dev/null
  fi
  msg_success "System logs cleared."
}

task_dns_flush() {
  msg_info "Flushing DNS cache..."
  
  if [ "$FLAG_DRY_RUN" = true ]; then
    msg_info "[DRY-RUN] Would flush DNS cache"
    return 0
  fi
  
  os_clear_dns ""
  msg_success "DNS cache flushed."
}

task_trash() {
  local trash_dir
  if is_macos; then
    trash_dir="$HOME/.Trash"
  else
    trash_dir="$HOME/.local/share/Trash/files"
  fi
  
  if [ ! -d "$trash_dir" ] || [ -z "$(ls -A "$trash_dir" 2>/dev/null)" ]; then
    msg_info "Trash is already empty."
    return 0
  fi
  
  local size
  size=$(get_dir_size "$trash_dir")
  msg_info "Emptying Trash ($size)..."
  
  if [ "$FLAG_DRY_RUN" = true ]; then
    msg_info "[DRY-RUN] Would empty trash containing $size"
    return 0
  fi
  
  rm -rf "${trash_dir:?}"/*
  msg_success "Trash emptied."
}

# --- Command Logic -----------------------------------------------------------

do_list() {
  echo ""
  msg_info "Available Maintenance Tasks"
  echo "============================"
  echo ""
  
  local tasks=("pkg-cleanup" "pkg-cache" "npm-cache" "pip-cache" "user-logs" "system-logs" "dns-flush" "trash")
  if is_macos; then
    tasks+=("xcode-derived" "spotlight-rebuild")
  fi
  
  for task in "${tasks[@]}"; do
    local enabled="disabled"
    local var_name="TASK_$(echo "$task" | tr '[:lower:]-' '[:upper:]_')"
    if [[ "${!var_name:-false}" == "true" ]]; then
      enabled="enabled"
    fi
    printf "  %-20s [%s]\n" "$task" "$enabled"
  done
  
  echo ""
}

do_run_task() {
  local task_name="$1"
  
  if [ -z "$task_name" ]; then
    die "Task name required. Run 'fc maintenance list' to see available tasks."
  fi
  
  local func_name="task_$(echo "$task_name" | tr '-' '_')"
  
  if ! declare -f "$func_name" >/dev/null 2>&1; then
    die "Unknown task: $task_name. Run 'fc maintenance list' to see available tasks."
  fi
  
  echo ""
  msg_info "Running maintenance task: $task_name"
  echo ""
  
  "$func_name"
  
  echo ""
  msg_success "Task complete: $task_name"
}

do_maintenance() {
  echo ""
  if [ "$FLAG_DRY_RUN" = true ]; then
    msg_info "[DRY-RUN] System Maintenance Preview"
  else
    msg_info "System Maintenance"
  fi
  echo "=================="
  echo ""
  
  local tasks_run=0
  
  # Run pkg-cleanup if enabled
  if [[ "${TASK_PKG_CLEANUP:-true}" == "true" ]] || [ "$FLAG_ALL" = true ]; then
    task_pkg_cleanup
    ((tasks_run++))
    echo ""
  fi
  
  # Run pkg-cache if enabled
  if [[ "${TASK_PKG_CACHE:-true}" == "true" ]] || [ "$FLAG_ALL" = true ]; then
    task_pkg_cache
    ((tasks_run++))
    echo ""
  fi
  
  # Run npm-cache if enabled
  if [[ "${TASK_NPM_CACHE:-true}" == "true" ]] || [ "$FLAG_ALL" = true ]; then
    task_npm_cache
    ((tasks_run++))
    echo ""
  fi
  
  # Run pip-cache if enabled
  if [[ "${TASK_PIP_CACHE:-true}" == "true" ]] || [ "$FLAG_ALL" = true ]; then
    task_pip_cache
    ((tasks_run++))
    echo ""
  fi
  
  # Run xcode-derived if enabled (macOS only)
  if is_macos && { [[ "${TASK_XCODE_DERIVED:-true}" == "true" ]] || [ "$FLAG_ALL" = true ]; }; then
    task_xcode_derived
    ((tasks_run++))
    echo ""
  fi
  
  # Run user-logs if enabled
  if [[ "${TASK_USER_LOGS:-true}" == "true" ]] || [ "$FLAG_ALL" = true ]; then
    task_user_logs
    ((tasks_run++))
    echo ""
  fi
  
  # Run trash if explicitly requested
  if [ "$FLAG_INCLUDE_TRASH" = true ] || [ "$FLAG_ALL" = true ]; then
    task_trash
    ((tasks_run++))
    echo ""
  fi
  
  echo ""
  if [ "$FLAG_DRY_RUN" = true ]; then
    msg_success "[DRY-RUN] Would have run $tasks_run maintenance task(s)."
  else
    msg_success "Maintenance complete! Ran $tasks_run task(s)."
  fi
}

# --- Main Dispatcher ---------------------------------------------------------

main() {
  # Parse global flags
  while [[ "${1:-}" == --* ]]; do
    case "$1" in
      --help)
        usage
        ;;
      --dry-run)
        FLAG_DRY_RUN=true
        shift
        ;;
      --all)
        FLAG_ALL=true
        shift
        ;;
      --include-trash)
        FLAG_INCLUDE_TRASH=true
        shift
        ;;
      *)
        break
        ;;
    esac
  done
  
  # No subcommand means run maintenance
  if [ -z "${1:-}" ]; then
    do_maintenance
    return
  fi
  
  local subcommand="$1"
  shift
  
  case "$subcommand" in
    list)
      do_list
      ;;
    run)
      do_run_task "$@"
      ;;
    *)
      die "Unknown subcommand: $subcommand. Run 'fc maintenance --help' for usage."
      ;;
  esac
}

main "$@"
