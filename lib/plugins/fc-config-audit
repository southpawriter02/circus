#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc-config-audit
#
# DESCRIPTION:  Configuration drift auditing for the Circus framework.
#               Compare live system state against YAML configurations
#               and report differences.
#
# REQUIRES:     yq (YAML processor)
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"
source "$DOTFILES_ROOT/lib/yaml_config.sh"

# --- Counters ---------------------------------------------------------------
AUDIT_OK=0
AUDIT_DRIFT=0
AUDIT_EXTRA=0
AUDIT_SKIPPED=0

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc config-audit <config.yaml> [options]"
  echo ""
  msg_info "Audit live system state against YAML configuration."
  echo ""
  msg_info "Options:"
  echo "  --packages         Audit packages only"
  echo "  --defaults         Audit macOS defaults only"
  echo "  --environment      Audit environment variables only"
  echo "  --aliases          Audit shell aliases only"
  echo "  --summary          Show summary only (no details)"
  echo ""
  msg_info "Examples:"
  echo "  fc config-audit roles/personal/config.yaml"
  echo "  fc config-audit roles/personal/config.yaml --packages"
  echo "  fc config-audit roles/personal/config.yaml --defaults"
  echo ""
  exit 0
}

# --- Audit Functions --------------------------------------------------------

audit_brew_formulae() {
  local config_file="$1"
  local count
  count=$(yaml_array_length "$config_file" ".packages.brew")
  
  if [[ "$count" -eq 0 || "$count" == "null" ]]; then
    return 0
  fi
  
  echo ""
  echo "üì¶ Homebrew Formulae:"
  
  # Get installed formulae
  local installed
  installed=$(brew list --formula 2>/dev/null | tr '\n' ' ')
  
  for ((i = 0; i < count; i++)); do
    local formula
    formula=$(yaml_get "$config_file" ".packages.brew[$i]")
    
    if [[ -n "$formula" && "$formula" != "null" ]]; then
      if echo "$installed" | grep -qw "$formula"; then
        echo "  ‚úÖ $formula"
        ((AUDIT_OK++))
      else
        echo "  ‚ùå $formula (MISSING)"
        ((AUDIT_DRIFT++))
      fi
    fi
  done
}

audit_brew_casks() {
  local config_file="$1"
  local count
  count=$(yaml_array_length "$config_file" ".packages.cask")
  
  if [[ "$count" -eq 0 || "$count" == "null" ]]; then
    return 0
  fi
  
  echo ""
  echo "üñ•Ô∏è  Homebrew Casks:"
  
  # Get installed casks
  local installed
  installed=$(brew list --cask 2>/dev/null | tr '\n' ' ')
  
  for ((i = 0; i < count; i++)); do
    local cask
    cask=$(yaml_get "$config_file" ".packages.cask[$i]")
    
    if [[ -n "$cask" && "$cask" != "null" ]]; then
      if echo "$installed" | grep -qw "$cask"; then
        echo "  ‚úÖ $cask"
        ((AUDIT_OK++))
      else
        echo "  ‚ùå $cask (MISSING)"
        ((AUDIT_DRIFT++))
      fi
    fi
  done
}

audit_mas_apps() {
  local config_file="$1"
  local count
  count=$(yaml_array_length "$config_file" ".packages.mas")
  
  if [[ "$count" -eq 0 || "$count" == "null" ]]; then
    return 0
  fi
  
  echo ""
  echo "üçé Mac App Store:"
  
  if ! command -v mas &>/dev/null; then
    echo "  ‚ö†Ô∏è  mas-cli not installed (skipping)"
    ((AUDIT_SKIPPED++))
    return 0
  fi
  
  # Get installed apps
  local installed
  installed=$(mas list 2>/dev/null)
  
  for ((i = 0; i < count; i++)); do
    local app_id app_name
    app_id=$(yaml_get "$config_file" ".packages.mas[$i].id")
    app_name=$(yaml_get "$config_file" ".packages.mas[$i].name")
    
    if [[ -n "$app_id" && "$app_id" != "null" ]]; then
      if echo "$installed" | grep -q "^$app_id"; then
        echo "  ‚úÖ $app_name ($app_id)"
        ((AUDIT_OK++))
      else
        echo "  ‚ùå $app_name ($app_id) (MISSING)"
        ((AUDIT_DRIFT++))
      fi
    fi
  done
}

audit_defaults() {
  local config_file="$1"
  local count
  count=$(yaml_array_length "$config_file" ".defaults")
  
  if [[ "$count" -eq 0 || "$count" == "null" ]]; then
    return 0
  fi
  
  echo ""
  echo "‚öôÔ∏è  macOS Defaults:"
  
  for ((i = 0; i < count; i++)); do
    local domain key type expected_value actual_value
    domain=$(yaml_get "$config_file" ".defaults[$i].domain")
    key=$(yaml_get "$config_file" ".defaults[$i].key")
    type=$(yaml_get "$config_file" ".defaults[$i].type")
    expected_value=$(yaml_get "$config_file" ".defaults[$i].value")
    
    if [[ -n "$domain" && "$domain" != "null" && -n "$key" && "$key" != "null" ]]; then
      # Read current value
      actual_value=$(defaults read "$domain" "$key" 2>/dev/null)
      
      if [[ -z "$actual_value" ]]; then
        echo "  ‚ùå $domain.$key (NOT SET, expected: $expected_value)"
        ((AUDIT_DRIFT++))
      else
        # Normalize boolean values for comparison
        local normalized_expected="$expected_value"
        local normalized_actual="$actual_value"
        
        if [[ "$type" == "bool" || "$type" == "boolean" ]]; then
          [[ "$expected_value" == "true" ]] && normalized_expected="1"
          [[ "$expected_value" == "false" ]] && normalized_expected="0"
        fi
        
        if [[ "$normalized_actual" == "$normalized_expected" ]]; then
          echo "  ‚úÖ $domain.$key = $actual_value"
          ((AUDIT_OK++))
        else
          echo "  ‚ùå $domain.$key (expected: $expected_value, actual: $actual_value)"
          ((AUDIT_DRIFT++))
        fi
      fi
    fi
  done
}

audit_environment() {
  local config_file="$1"
  local count
  count=$(yaml_array_length "$config_file" ".environment")
  
  if [[ "$count" -eq 0 || "$count" == "null" ]]; then
    return 0
  fi
  
  echo ""
  echo "üîÑ Environment Variables:"
  
  for ((i = 0; i < count; i++)); do
    local name expected_value actual_value
    name=$(yaml_get "$config_file" ".environment[$i].name")
    expected_value=$(yaml_get "$config_file" ".environment[$i].value")
    
    if [[ -n "$name" && "$name" != "null" ]]; then
      # Get current value from environment
      actual_value="${!name}"
      
      if [[ -z "$actual_value" ]]; then
        echo "  ‚ùå $name (NOT SET, expected: $expected_value)"
        ((AUDIT_DRIFT++))
      elif [[ "$actual_value" == "$expected_value" ]]; then
        echo "  ‚úÖ $name = $actual_value"
        ((AUDIT_OK++))
      else
        echo "  ‚ö†Ô∏è  $name (expected: $expected_value, actual: $actual_value)"
        ((AUDIT_DRIFT++))
      fi
    fi
  done
}

audit_aliases() {
  local config_file="$1"
  local count
  count=$(yaml_array_length "$config_file" ".aliases")
  
  if [[ "$count" -eq 0 || "$count" == "null" ]]; then
    return 0
  fi
  
  echo ""
  echo "üìù Shell Aliases:"
  
  # Check alias file
  local alias_file="$HOME/.aliases.local"
  
  if [[ ! -f "$alias_file" ]]; then
    echo "  ‚ö†Ô∏è  Alias file not found: $alias_file"
    ((AUDIT_SKIPPED++))
    return 0
  fi
  
  for ((i = 0; i < count; i++)); do
    local name command
    name=$(yaml_get "$config_file" ".aliases[$i].name")
    command=$(yaml_get "$config_file" ".aliases[$i].command")
    
    if [[ -n "$name" && "$name" != "null" ]]; then
      if grep -q "alias $name=" "$alias_file" 2>/dev/null; then
        echo "  ‚úÖ $name"
        ((AUDIT_OK++))
      else
        echo "  ‚ùå $name (NOT DEFINED)"
        ((AUDIT_DRIFT++))
      fi
    fi
  done
}

print_summary() {
  echo ""
  echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
  echo ""
  
  local total=$((AUDIT_OK + AUDIT_DRIFT + AUDIT_EXTRA))
  
  if [[ $AUDIT_DRIFT -eq 0 && $AUDIT_EXTRA -eq 0 ]]; then
    msg_success "All checks passed! ($AUDIT_OK items)"
  else
    echo "üìä Summary:"
    echo "   ‚úÖ OK:      $AUDIT_OK"
    echo "   ‚ùå Drift:   $AUDIT_DRIFT"
    [[ $AUDIT_EXTRA -gt 0 ]] && echo "   ‚ö†Ô∏è  Extra:   $AUDIT_EXTRA"
    [[ $AUDIT_SKIPPED -gt 0 ]] && echo "   ‚è≠Ô∏è  Skipped: $AUDIT_SKIPPED"
    echo ""
    
    if [[ $AUDIT_DRIFT -gt 0 ]]; then
      msg_warning "Configuration drift detected."
      msg_info "Run 'fc config apply <config.yaml>' to fix."
    fi
  fi
}

# --- Main -------------------------------------------------------------------
main() {
  if [[ -z "$1" ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
    usage
  fi
  
  local config_file="$1"
  shift
  
  # Parse options
  local audit_packages=true
  local audit_defs=true
  local audit_env=true
  local audit_alias=true
  local summary_only=false
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --packages)
        audit_defs=false; audit_env=false; audit_alias=false
        shift ;;
      --defaults)
        audit_packages=false; audit_env=false; audit_alias=false
        shift ;;
      --environment)
        audit_packages=false; audit_defs=false; audit_alias=false
        shift ;;
      --aliases)
        audit_packages=false; audit_defs=false; audit_env=false
        shift ;;
      --summary)
        summary_only=true
        shift ;;
      *)
        shift ;;
    esac
  done
  
  # Resolve relative paths
  if [[ ! -f "$config_file" ]]; then
    config_file="$DOTFILES_ROOT/$config_file"
  fi
  
  if [[ ! -f "$config_file" ]]; then
    die "Configuration file not found: $1"
  fi
  
  if ! check_yq_installed; then
    die "yq is required. Install with: brew install yq"
  fi
  
  # Header
  local role_name
  role_name=$(yaml_get "$config_file" ".metadata.name")
  
  echo ""
  msg_info "üìã Auditing: $role_name"
  msg_info "   $(basename "$config_file")"
  
  # Run audits
  if [[ "$audit_packages" == "true" ]]; then
    audit_brew_formulae "$config_file"
    audit_brew_casks "$config_file"
    audit_mas_apps "$config_file"
  fi
  
  if [[ "$audit_defs" == "true" ]]; then
    audit_defaults "$config_file"
  fi
  
  if [[ "$audit_env" == "true" ]]; then
    audit_environment "$config_file"
  fi
  
  if [[ "$audit_alias" == "true" ]]; then
    audit_aliases "$config_file"
  fi
  
  # Summary
  print_summary
  
  # Exit with error if drift detected
  [[ $AUDIT_DRIFT -gt 0 ]] && exit 1
  exit 0
}

main "$@"
