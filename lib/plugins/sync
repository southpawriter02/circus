#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         sync
#
# DESCRIPTION:  This script handles the encrypted backup and restoration of
#               system state, including application settings, user data, and a
#               list of installed packages.
#
# ==============================================================================

# --- Setup & Helpers ---
source "$(dirname "${BASH_SOURCE[0]}")/../lib/helpers.sh"

# --- Configuration ---

readonly BACKUP_DEST_DIR="$HOME"
readonly BACKUP_ARCHIVE_NAME="circus_backup.tar.gz.gpg"
readonly GPG_RECIPIENT_ID="YOUR_GPG_KEY_ID_HERE"

readonly BACKUP_TARGETS=(
  "$HOME/.ssh"
  "$HOME/.gnupg"
  "$HOME/Documents"
)

# --- Usage Information ---
usage() {
  msg_info "Usage: fc sync <subcommand>"
  echo ""
  msg_info "Manages the encrypted backup and restoration of system state."
  echo ""
  msg_info "Subcommands:"
  echo "  backup    - Backs up and encrypts critical data."
  echo "  restore   - Decrypts and restores data from an encrypted backup."
  exit 0
}

# --- Command Logic ---

do_backup() {
  if [ "$GPG_RECIPIENT_ID" == "YOUR_GPG_KEY_ID_HERE" ]; then
    die "GPG_RECIPIENT_ID is not configured. Please edit the sync plugin to set it."
  fi

  local temp_backup_dir
  temp_backup_dir=$(mktemp -d)
  msg_info "Created temporary backup directory: $temp_backup_dir"

  msg_info "Creating application inventory..."
  brew bundle dump --force --file="$temp_backup_dir/Brewfile.dump"

  msg_info "Backing up critical files..."
  for target in "${BACKUP_TARGETS[@]}"; do
    local expanded_target
    eval expanded_target="$target"
    if [ -e "$expanded_target" ]; then
      rsync -a "$expanded_target" "$temp_backup_dir/"
    fi
  done

  msg_info "Creating and encrypting backup archive..."
  local final_archive_path="$BACKUP_DEST_DIR/$BACKUP_ARCHIVE_NAME"
  tar -czf - -C "$temp_backup_dir" . | gpg -e -r "$GPG_RECIPIENT_ID" -o "$final_archive_path"

  msg_info "Cleaning up temporary files..."
  rm -rf "$temp_backup_dir"

  msg_success "Encrypted backup created at: $final_archive_path"
}

do_restore() {
  local encrypted_archive_path="$BACKUP_DEST_DIR/$BACKUP_ARCHIVE_NAME"
  if [ ! -f "$encrypted_archive_path" ]; then
    die "Encrypted backup archive not found at: $encrypted_archive_path"
  fi

  local temp_restore_dir
  temp_restore_dir=$(mktemp -d)
  msg_info "Decrypting backup... You may be prompted for your GPG passphrase."
  
  # The `set -e` option in helpers.sh will cause the script to exit if gpg fails.
  # The global error trap will provide a detailed error message.
  gpg -d "$encrypted_archive_path" | tar -xzf - -C "$temp_restore_dir"
  msg_success "Decryption and extraction successful."

  msg_info "Restoring applications from inventory..."
  brew bundle install --file="$temp_restore_dir/Brewfile.dump"

  msg_info "Restoring critical files..."
  for target in "${BACKUP_TARGETS[@]}"; do
    local backup_source="$temp_restore_dir/$(basename "$target")"
    local restore_dest
    eval restore_dest="$target"
    if [ -e "$backup_source" ]; then
      rsync -a "$backup_source" "$(dirname "$restore_dest")"
    fi
  done

  msg_info "Cleaning up temporary files..."
  rm -rf "$temp_restore_dir"

  msg_success "System restoration complete."
}

# --- Main Dispatcher ---
main() {
  if [ -z "$1" ] || [ "$1" == "--help" ]; then
    usage
  fi

  if ! command -v gpg >/dev/null 2>&1; then
    die "GPG is not installed. Please run 'brew install gpg-suite'."
  fi

  local subcommand="$1"
  shift

  case "$subcommand" in
    backup)
      prompt_for_confirmation "Ready to begin the encrypted backup process."
      do_backup
      ;;
    restore)
      prompt_for_confirmation "Ready to restore from an encrypted backup. This may overwrite existing files."
      do_restore
      ;;
    *)
      die "Unknown subcommand: $subcommand. Run 'fc sync --help' for available subcommands."
      ;;
  esac
}

main "$@"
