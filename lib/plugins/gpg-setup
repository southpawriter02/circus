#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         gpg-setup
#
# DESCRIPTION:  An interactive utility to generate a GPG key and configure Git
#               to use it for signing commits.
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the centralized initialization script to set up the environment.
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc gpg-setup"
  echo ""
  msg_info "Interactively generates a new GPG key and configures Git for signing."
  echo ""
  exit 0
}

# --- Main Logic -------------------------------------------------------------
main() {
  if [ "$1" == "--help" ]; then
    usage
  fi

  msg_info "This utility will guide you through generating a GPG key and configuring Git."

  # 1. Check if GPG is installed
  if ! command -v gpg >/dev/null 2>&1; then
    die "The 'gpg' command is required but not found. Please install GPG Suite first."
  fi

  # 2. Generate the GPG key
  echo ""
  msg_info "First, let's generate a new GPG key."
  msg_info "You will be prompted for your name, email, and a passphrase."
  gpg --full-generate-key

  echo ""
  msg_success "GPG key generated successfully."

  # 3. Get the new key ID
  msg_info "Now, let's find the ID of the key you just created."
  local key_id
  key_id=$(gpg --list-secret-keys --keyid-format LONG | grep 'sec' | tail -n 1 | awk '{print $2}' | cut -d'/' -f2)

  if [ -z "$key_id" ]; then
    die "Could not automatically determine the new GPG key ID. Please check your GPG setup."
  fi

  msg_success "Found GPG Key ID: $key_id"

  # 4. Configure Git
  echo ""
  msg_info "Configuring Git to use this key for signing..."
  git config --global user.signingkey "$key_id"
  git config --global commit.gpgsign true
  msg_success "Git configuration updated."

  # 5. Export and display the public key
  echo ""
  msg_info "Your public GPG key is below. Copy and paste it into your GitHub account."
  msg_info "(Settings -> SSH and GPG keys -> New GPG key)"
  echo "----------------------------------------------------------------------"
  gpg --armor --export "$key_id"
  echo "----------------------------------------------------------------------"

  echo ""
  msg_success "Success! Git is now configured to sign your commits with your new GPG key."
}

main "$@"
