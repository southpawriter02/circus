#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc-lock
#
# DESCRIPTION:  Control screen lock and display sleep settings.
#               Provides quick commands for screen security management.
#
# CROSS-PLATFORM:
#   - macOS: Uses pmset, osascript, defaults
#   - Linux: Uses loginctl, gnome-screensaver-command, xdg-screensaver
#
# USAGE:        fc lock <action> [value]
#
# ACTIONS:
#   now         Lock the screen immediately
#   status      Show current lock settings (macOS only)
#   require     Configure password requirement (macOS only)
#   timeout     Set display sleep timeout (macOS only)
#   screensaver Start the screen saver
#
# EXAMPLES:
#   fc lock now                 # Lock screen immediately
#   fc lock screensaver         # Start screen saver
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc lock <action> [value]"
  echo ""
  msg_info "Control screen lock and display sleep settings."
  echo ""
  msg_info "Actions:"
  echo "  now               - Lock the screen immediately"
  echo "  screensaver       - Start screen saver now"
  if is_macos; then
    echo "  status            - Show current lock settings"
    echo "  require <on/off>  - Require password after sleep"
    echo "  timeout <seconds> - Set display sleep timeout"
  fi
  echo ""
  msg_info "Examples:"
  echo "  fc lock now              # Lock immediately"
  echo "  fc lock screensaver      # Start screen saver"
  echo ""
  exit 0
}


# --- Action Functions -------------------------------------------------------

# Lock screen immediately
action_now() {
  msg_info "Locking screen..."
  os_lock_screen
}

# Start screen saver
action_screensaver() {
  msg_info "Starting screen saver..."
  
  if is_macos; then
    open -a ScreenSaverEngine 2>/dev/null || \
      /System/Library/CoreServices/ScreenSaverEngine.app/Contents/MacOS/ScreenSaverEngine &
    msg_success "Screen saver started"
  elif is_linux; then
    if command -v xdg-screensaver &>/dev/null; then
      xdg-screensaver activate
      msg_success "Screen saver started"
    elif command -v gnome-screensaver-command &>/dev/null; then
      gnome-screensaver-command --activate
      msg_success "Screen saver started"
    else
      msg_warning "No screen saver tool found"
    fi
  fi
}

# Show current lock settings (macOS only)
action_status() {
  if ! is_macos; then
    die "fc lock status is only available on macOS"
  fi
  
  msg_info "Screen Lock Settings"
  echo ""
  
  # Display sleep timeout (AC power)
  local display_sleep_ac
  display_sleep_ac=$(pmset -g custom 2>/dev/null | grep -A 20 "AC Power" | grep "displaysleep" | awk '{print $2}')
  
  # Display sleep timeout (battery)
  local display_sleep_bat
  display_sleep_bat=$(pmset -g custom 2>/dev/null | grep -A 20 "Battery Power" | grep "displaysleep" | awk '{print $2}')
  
  # Password requirement
  local ask_for_password
  ask_for_password=$(defaults read com.apple.screensaver askForPassword 2>/dev/null || echo "unknown")
  
  # Password delay
  local password_delay
  password_delay=$(defaults read com.apple.screensaver askForPasswordDelay 2>/dev/null || echo "0")
  
  # Format output
  echo "  Password Required:    $([ "$ask_for_password" = "1" ] && echo "Yes ✓" || echo "No ✗")"
  
  if [[ "$password_delay" == "0" ]]; then
    echo "  Password Delay:       Immediately"
  else
    echo "  Password Delay:       $password_delay seconds"
  fi
  
  if [[ -n "$display_sleep_ac" ]]; then
    if [[ "$display_sleep_ac" == "0" ]]; then
      echo "  Display Sleep (AC):   Never"
    else
      echo "  Display Sleep (AC):   $display_sleep_ac minutes"
    fi
  fi
  
  if [[ -n "$display_sleep_bat" ]]; then
    if [[ "$display_sleep_bat" == "0" ]]; then
      echo "  Display Sleep (Bat):  Never"
    else
      echo "  Display Sleep (Bat):  $display_sleep_bat minutes"
    fi
  fi
  
  echo ""
}

# Configure password requirement (macOS only)
action_require() {
  if ! is_macos; then
    die "fc lock require is only available on macOS"
  fi
  
  local setting="$1"
  
  if [[ -z "$setting" ]]; then
    local current
    current=$(defaults read com.apple.screensaver askForPassword 2>/dev/null || echo "0")
    if [[ "$current" == "1" ]]; then
      msg_info "Password is currently required after sleep."
    else
      msg_info "Password is NOT required after sleep."
    fi
    return 0
  fi
  
  case "$setting" in
    on|yes|1|true)
      msg_info "Requiring password after sleep..."
      defaults write com.apple.screensaver askForPassword -int 1
      defaults write com.apple.screensaver askForPasswordDelay -int 0
      msg_success "Password will be required immediately after sleep."
      ;;
    off|no|0|false)
      msg_warning "Disabling password requirement after sleep..."
      msg_warning "This is a security risk. Are you sure? (y/N):"
      read -r confirm
      if [[ "$confirm" == "y" ]] || [[ "$confirm" == "Y" ]]; then
        defaults write com.apple.screensaver askForPassword -int 0
        msg_success "Password will NOT be required after sleep."
      else
        msg_info "Cancelled."
      fi
      ;;
    *)
      die "Invalid setting. Use 'on' or 'off'."
      ;;
  esac
}

# Set display sleep timeout (macOS only)
action_timeout() {
  if ! is_macos; then
    die "fc lock timeout is only available on macOS"
  fi
  
  local seconds="$1"
  
  if [[ -z "$seconds" ]]; then
    die "Please provide timeout in seconds (0 = never)."
  fi
  
  if ! [[ "$seconds" =~ ^[0-9]+$ ]]; then
    die "Timeout must be a number (in seconds)."
  fi
  
  local minutes=$((seconds / 60))
  
  if [[ $((seconds % 60)) -gt 0 ]]; then
    minutes=$((minutes + 1))
  fi
  
  if [[ "$seconds" == "0" ]]; then
    msg_info "Setting display to never sleep..."
    minutes=0
  else
    msg_info "Setting display sleep to $minutes minutes ($seconds seconds)..."
  fi
  
  if sudo pmset -a displaysleep "$minutes" 2>/dev/null; then
    if [[ "$seconds" == "0" ]]; then
      msg_success "Display will never sleep."
    else
      msg_success "Display will sleep after $minutes minute(s)."
    fi
  else
    msg_warning "Could not set system-wide timeout (may need sudo)."
  fi
}

# --- Main Logic -------------------------------------------------------------
main() {
  if [[ -z "$1" ]] || [[ "$1" == "--help" ]]; then
    usage
  fi

  local action="$1"
  shift

  case "$action" in
    now)
      action_now
      ;;
    status)
      action_status
      ;;
    require)
      action_require "$1"
      ;;
    timeout)
      action_timeout "$1"
      ;;
    screensaver|saver)
      action_screensaver
      ;;
    *)
      die "Unknown action '$action'. Run 'fc lock --help' for available actions."
      ;;
  esac
}

main "$@"
