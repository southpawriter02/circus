#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         ssh-keygen
#
# DESCRIPTION:  A utility to streamline the creation of a new SSH key.
#               It generates a key, adds it to the ssh-agent, and copies the
#               public key to the clipboard.
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the centralized initialization script to set up the environment.
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc ssh-keygen"
  echo ""
  msg_info "Generates a new ed25519 SSH key, adds it to the ssh-agent, and copies"
  msg_info "the public key to the clipboard."
  echo ""
  exit 0
}

# --- Main Logic -------------------------------------------------------------
main() {
  if [ "$1" == "--help" ]; then
    usage
  fi

  # 1. Prompt for user email
  msg_info "Please enter the email address to associate with your new SSH key:"
  read -p "> " email
  if [ -z "$email" ]; then
    die "Email address cannot be empty."
  fi

  local key_path="$HOME/.ssh/id_ed25519"

  # Check if the key already exists and ask for confirmation.
  if [ -f "$key_path" ]; then
    msg_warning "SSH key already exists at $key_path."
    read -p "Do you want to overwrite it? (y/n) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      die "Aborted by user."
    fi
  fi

  msg_info "Generating a new ed25519 SSH key at $key_path..."

  # 2. Generate the SSH key
  # The -N "" provides an empty passphrase to avoid interactive prompts here.
  # The user will be prompted by ssh-add later to set it in the keychain.
  ssh-keygen -t ed25519 -C "$email" -f "$key_path" -N ""

  msg_success "SSH key generated successfully."

  # 3. Start the ssh-agent if it's not running
  if ! pgrep -u "$USER" ssh-agent > /dev/null; then
    msg_info "Starting ssh-agent..."
    eval "$(ssh-agent -s)"
  fi

  # 4. Add the key to the ssh-agent and store passphrase in Keychain
  msg_info "Adding SSH key to the ssh-agent and storing passphrase in Keychain..."
  ssh-add --apple-use-keychain "$key_path"

  # 5. Copy the public key to the clipboard
  msg_info "Copying public key to clipboard..."
  pbcopy < "${key_path}.pub"

  echo ""
  msg_success "Success! Your new public SSH key has been copied to the clipboard."
  msg_info "You can now paste it into GitHub, GitLab, or any other service."
}

main "$@"
