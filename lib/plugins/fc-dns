#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc-dns
#
# DESCRIPTION:  Manage the system's DNS settings from the command line.
#               Allows viewing, setting, and clearing custom DNS servers for
#               the active network interface.
#
# CROSS-PLATFORM:
#   - macOS: Uses networksetup (built-in)
#   - Linux: Uses resolvectl (systemd-resolved) or /etc/resolv.conf
#
# REQUIRES:
#   - macOS 10.6+ or Linux
#   - Active network connection
#   - Administrator privileges for set/clear operations
#
# ACTIONS:
#   get/status  - Show current DNS servers
#   set <ip>... - Set one or more custom DNS servers
#   clear       - Clear custom DNS, revert to DHCP-provided servers
#
# EXAMPLES:
#   fc dns get                       # Show current DNS servers
#   fc dns set 8.8.8.8 8.8.4.4       # Use Google DNS
#   fc dns set 1.1.1.1               # Use Cloudflare DNS
#   fc dns clear                     # Revert to DHCP DNS
#
# POPULAR DNS PROVIDERS:
#   Google:     8.8.8.8, 8.8.4.4
#   Cloudflare: 1.1.1.1, 1.0.0.1
#   OpenDNS:    208.67.222.222, 208.67.220.220
#   Quad9:      9.9.9.9, 149.112.112.112
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc dns <action> [dns_servers...]"
  echo ""
  msg_info "Manages the DNS settings for the active network service."
  msg_info "This command requires administrator privileges to change settings."
  echo ""
  msg_info "Actions:"
  echo "  get             - Show the current DNS servers."
  echo "  set <ip>...     - Set one or more custom DNS servers."
  echo "  clear           - Clear custom DNS servers, reverting to default."
  echo "  status          - Alias for 'get'."
  echo ""
  msg_info "Examples:"
  echo "  fc dns get                     # View current DNS"
  echo "  fc dns set 8.8.8.8 8.8.4.4     # Use Google DNS"
  echo "  fc dns set 1.1.1.1 1.0.0.1     # Use Cloudflare DNS"
  echo "  fc dns clear                   # Use DHCP-provided DNS"
  echo ""
  msg_info "Popular DNS Providers:"
  echo "  Google:     8.8.8.8, 8.8.4.4"
  echo "  Cloudflare: 1.1.1.1, 1.0.0.1"
  echo "  OpenDNS:    208.67.222.222, 208.67.220.220"
  echo "  Quad9:      9.9.9.9, 149.112.112.112"
  echo ""
  if is_linux; then
    msg_info "Linux: Uses resolvectl or /etc/resolv.conf"
  fi
  exit 0
}

# --- Helper Functions -------------------------------------------------------

# Get the name of the active network service (macOS only)
get_active_network_service() {
  if is_macos; then
    # Find the active network service based on the default route
    local active_device
    active_device=$(route -n get default 2>/dev/null | grep 'interface' | awk '{print $2}')
    
    if [[ -n "$active_device" ]]; then
      # Map device to network service name
      networksetup -listallhardwareports | grep -B1 "Device: $active_device" | grep "Hardware Port:" | sed 's/Hardware Port: //'
    else
      # Fallback: try Wi-Fi first, then Ethernet
      echo "Wi-Fi"
    fi
  else
    # Linux: return empty (not used)
    echo ""
  fi
}

# --- Main Logic -------------------------------------------------------------
main() {
  if [ -z "$1" ] || [ "$1" == "--help" ]; then
    usage
  fi

  # --- Find Active Network Service (macOS) ----------------------------------
  local service=""
  if is_macos; then
    service=$(get_active_network_service)
    if [ -z "$service" ]; then
      die "No active network service found."
    fi
    msg_info "Active network service: $service"
  fi

  ACTION="$1"
  shift

  case "$ACTION" in

    # --- Action: get/status -------------------------------------------------
    get|status)
      msg_info "Current DNS servers:"
      os_get_dns "$service"
      ;;

    # --- Action: set --------------------------------------------------------
    set)
      if [ -z "$1" ]; then
        die "You must provide at least one DNS server IP address."
      fi
      msg_info "Setting DNS servers to: $*"
      os_set_dns "$service" "$@"
      msg_success "DNS servers have been updated."
      ;;

    # --- Action: clear ------------------------------------------------------
    clear)
      msg_info "Clearing DNS servers..."
      os_clear_dns "$service"
      msg_success "DNS servers have been cleared. System will use DHCP-provided servers."
      ;;

    *)
      die "Unknown action '$ACTION'. Run 'fc dns --help' for available actions."
      ;;
  esac
}

main "$@"
