#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         dns
#
# DESCRIPTION:  This command manages the system's DNS settings.
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the centralized initialization script to set up the environment.
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc dns <action> [dns_servers...]"
  echo ""
  msg_info "Manages the DNS settings for the active network service."
  msg_info "This command requires administrator privileges to change settings."
  echo ""
  msg_info "Actions:"
  echo "  get             - Show the current DNS servers."
  echo "  set <ip>...     - Set one or more custom DNS servers (e.g., 8.8.8.8 1.1.1.1)."
  echo "  clear           - Clear custom DNS servers, reverting to the default."
  echo "  status          - Alias for 'get'."
  echo ""
  exit 0
}

# --- Main Logic -------------------------------------------------------------
main() {
  if [ -z "$1" ] || [ "$1" == "--help" ]; then
    usage
  fi

  # Find the active network service (e.g., Wi-Fi, Ethernet).
  # The `|| true` is important here to prevent `set -e` from exiting if grep finds no match.
  local service
  service=$(networksetup -listallnetworkservices | grep -i 'connected' | head -n 1 || true)

  if [ -z "$service" ]; then
    die "No active and connected network service found."
  fi
  msg_info "Active network service: $service"

  ACTION="$1"
  shift # Remove the action from the argument list

  case "$ACTION" in
    get|status)
      msg_info "Current DNS servers:"
      networksetup -getdnsservers "$service"
      ;;
    set)
      if [ -z "$1" ]; then
        die "You must provide at least one DNS server IP address."
      fi
      msg_info "Setting DNS servers to: $*"
      sudo networksetup -setdnsservers "$service" "$@"
      msg_success "DNS servers have been updated."
      ;;
    clear)
      msg_info "Clearing DNS servers..."
      sudo networksetup -setdnsservers "$service" "Empty"
      msg_success "DNS servers have been cleared. The system will now use the default (DHCP-provided) servers."
      ;;
    *)
      die "Unknown action '$ACTION'. Run 'fc dns --help' for available actions."
      ;;
  esac
}

main "$@"
