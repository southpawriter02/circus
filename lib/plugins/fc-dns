#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc-dns
#
# DESCRIPTION:  Manage the system's DNS settings from the command line.
#               Allows viewing, setting, and clearing custom DNS servers for
#               the active network interface. Useful for switching between
#               different DNS providers or troubleshooting network issues.
#
# REQUIRES:
#   - macOS 10.6 or later (networksetup command)
#   - Active network connection (Wi-Fi or Ethernet)
#   - Administrator privileges for set/clear operations
#
# DEPENDENCIES:
#   - networksetup (built-in macOS utility)
#   - sudo (for modifying DNS settings)
#
# REFERENCES:
#   - Apple Documentation: networksetup
#     https://ss64.com/mac/networksetup.html
#   - man networksetup
#   - Popular DNS providers:
#     - Google: 8.8.8.8, 8.8.4.4
#     - Cloudflare: 1.1.1.1, 1.0.0.1
#     - OpenDNS: 208.67.222.222, 208.67.220.220
#     - Quad9: 9.9.9.9, 149.112.112.112
#
# ACTIONS:
#   get/status  - Show current DNS servers
#   set <ip>... - Set one or more custom DNS servers
#   clear       - Clear custom DNS, revert to DHCP-provided servers
#
# EXAMPLES:
#   fc dns get                       # Show current DNS servers
#   fc dns set 8.8.8.8 8.8.4.4       # Use Google DNS
#   fc dns set 1.1.1.1               # Use Cloudflare DNS
#   fc dns clear                     # Revert to DHCP DNS
#
# NOTES:
#   - DNS changes require administrator (sudo) password
#   - "Empty" is a special value that clears custom DNS settings
#   - The active network service is automatically detected
#   - Multiple DNS servers provide redundancy
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the centralized initialization script to set up the environment.
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc dns <action> [dns_servers...]"
  echo ""
  msg_info "Manages the DNS settings for the active network service."
  msg_info "This command requires administrator privileges to change settings."
  echo ""
  msg_info "Actions:"
  echo "  get             - Show the current DNS servers."
  echo "  set <ip>...     - Set one or more custom DNS servers (e.g., 8.8.8.8 1.1.1.1)."
  echo "  clear           - Clear custom DNS servers, reverting to the default."
  echo "  status          - Alias for 'get'."
  echo ""
  msg_info "Examples:"
  echo "  fc dns get                     # View current DNS"
  echo "  fc dns set 8.8.8.8 8.8.4.4     # Use Google DNS"
  echo "  fc dns set 1.1.1.1 1.0.0.1     # Use Cloudflare DNS"
  echo "  fc dns clear                   # Use DHCP-provided DNS"
  echo ""
  msg_info "Popular DNS Providers:"
  echo "  Google:     8.8.8.8, 8.8.4.4"
  echo "  Cloudflare: 1.1.1.1, 1.0.0.1"
  echo "  OpenDNS:    208.67.222.222, 208.67.220.220"
  echo "  Quad9:      9.9.9.9, 149.112.112.112"
  echo ""
  exit 0
}

# --- Helper Functions -------------------------------------------------------

# Get the name of the active network service (e.g., "Wi-Fi", "Ethernet")
# This queries networksetup to find services, then identifies the connected one
get_active_network_service() {
  # List all network services and find one that's connected
  # The '|| true' prevents set -e from exiting if grep finds no match
  networksetup -listallnetworkservices | grep -i 'connected' | head -n 1 || true
}

# --- Main Logic -------------------------------------------------------------
main() {
  if [ -z "$1" ] || [ "$1" == "--help" ]; then
    usage
  fi

  # --- Find Active Network Service ------------------------------------------
  # macOS can have multiple network services (Wi-Fi, Ethernet, etc.)
  # We identify the currently active/connected one to modify its DNS.
  local service
  service=$(get_active_network_service)

  if [ -z "$service" ]; then
    die "No active and connected network service found."
  fi
  msg_info "Active network service: $service"

  ACTION="$1"
  shift # Remove the action from the argument list

  case "$ACTION" in

    # --- Action: get/status -------------------------------------------------
    # Display the current DNS servers for the active network service
    # Uses: networksetup -getdnsservers <service>
    # Output: List of DNS IPs, or "There aren't any DNS Servers set" if using DHCP
    get|status)
      msg_info "Current DNS servers:"
      networksetup -getdnsservers "$service"
      ;;

    # --- Action: set --------------------------------------------------------
    # Set custom DNS servers for the active network service
    # Uses: networksetup -setdnsservers <service> <ip1> [ip2] [ip3]...
    # Note: Requires sudo. Multiple servers provide fallback redundancy.
    set)
      if [ -z "$1" ]; then
        die "You must provide at least one DNS server IP address."
      fi
      msg_info "Setting DNS servers to: $*"
      sudo networksetup -setdnsservers "$service" "$@"
      msg_success "DNS servers have been updated."
      ;;

    # --- Action: clear ------------------------------------------------------
    # Clear custom DNS servers, reverting to DHCP-provided servers
    # Uses: networksetup -setdnsservers <service> "Empty"
    # Note: "Empty" is a special keyword that clears the custom DNS list
    clear)
      msg_info "Clearing DNS servers..."
      sudo networksetup -setdnsservers "$service" "Empty"
      msg_success "DNS servers have been cleared. The system will now use the default (DHCP-provided) servers."
      ;;

    *)
      die "Unknown action '$ACTION'. Run 'fc dns --help' for available actions."
      ;;
  esac
}

main "$@"
