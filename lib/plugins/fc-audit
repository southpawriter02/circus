#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc-audit
#
# DESCRIPTION:  Run a security audit to check system protection settings.
#               Verifies critical macOS security features are enabled and
#               provides a security posture score.
#
# USAGE:        fc audit <action>
#
# ACTIONS:
#   run         Run full security audit (8 checks)
#               - System Protection: SIP, FileVault, Gatekeeper, Firewall
#               - Authentication: Password after sleep, Auto login
#               - Network: Stealth mode, Remote login (SSH)
#               - Provides pass/fail score
#
#   quick       Quick check of 4 critical settings
#               - SIP, FileVault, Gatekeeper, Firewall only
#               - Fast way to verify essential protections
#
#   sip         Check System Integrity Protection details
#               - Shows what SIP protects
#               - Instructions for modification (requires Recovery Mode)
#
#   filevault   Check FileVault disk encryption status
#               - Shows encryption state and enabled users
#               - Link to enable if disabled
#
#   gatekeeper  Check Gatekeeper status
#               - Explains what Gatekeeper protects against
#               - Command to re-enable if disabled
#
#   firewall    Check Application Firewall details
#               - Global state, stealth mode, block all mode
#               - Link to System Settings for management
#
# EXAMPLES:
#   fc audit run            # Full audit with scoring
#   fc audit quick          # Fast 4-check summary
#   fc audit sip            # SIP details
#   fc audit filevault      # Encryption status
#
# SECURITY CHECKS EXPLAINED:
#
#   SIP (System Integrity Protection):
#     Protects system files from modification, even by root.
#     Should always be enabled unless developing kexts.
#
#   FileVault:
#     Full-disk encryption protecting data if Mac is stolen.
#     Strongly recommended for all portable Macs.
#
#   Gatekeeper:
#     Blocks unsigned and unnotarized apps from running.
#     Prevents most malware installations.
#
#   Application Firewall:
#     Controls incoming network connections per-app.
#     Stealth mode hides Mac from network scans.
#
#   Password After Sleep:
#     Requires password to unlock after sleep/screensaver.
#     Essential for physical security.
#
#   Automatic Login:
#     Should be disabled; bypasses login authentication.
#
#   Remote Login (SSH):
#     Allows remote terminal access. Enable only if needed.
#
# RECOMMENDATIONS:
#   - Run 'fc audit run' periodically (monthly)
#   - All items should show âœ“ for maximum security
#   - FileVault and Password After Sleep are critical for laptops
#   - Disable Remote Login unless actively using SSH
#
# DEPENDENCIES:
#   Required: csrutil, fdesetup, spctl, systemsetup (built-in to macOS)
#   Required: defaults, socketfilterfw (built-in to macOS)
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the common initialization script for logging and error handling
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc audit <action>"
  echo ""
  msg_info "Run security audits to check system protection settings."
  echo ""
  msg_info "Actions:"
  echo "  run             - Run full security audit"
  echo "  quick           - Quick check of critical settings"
  echo "  sip             - Check System Integrity Protection"
  echo "  filevault       - Check FileVault encryption status"
  echo "  gatekeeper      - Check Gatekeeper status"
  echo "  firewall        - Check firewall status"
  echo ""
  msg_info "Examples:"
  echo "  fc audit run          # Full audit with score"
  echo "  fc audit quick        # Fast 4-check summary"
  echo ""
  exit 0
}


# --- Check Functions --------------------------------------------------------

# Check SIP status, returns 0 if enabled
check_sip() {
  local status
  status=$(csrutil status 2>/dev/null)
  if echo "$status" | grep -q "enabled"; then
    echo "enabled"
    return 0
  else
    echo "disabled"
    return 1
  fi
}

# Check FileVault status
check_filevault() {
  local status
  status=$(fdesetup status 2>/dev/null)
  if echo "$status" | grep -qi "FileVault is On"; then
    echo "enabled"
    return 0
  elif echo "$status" | grep -qi "in progress"; then
    echo "encrypting"
    return 0
  else
    echo "disabled"
    return 1
  fi
}

# Check Gatekeeper status
check_gatekeeper() {
  local status
  status=$(spctl --status 2>/dev/null)
  if echo "$status" | grep -q "assessments enabled"; then
    echo "enabled"
    return 0
  else
    echo "disabled"
    return 1
  fi
}

# Check firewall status
check_firewall() {
  local status
  status=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate 2>/dev/null)
  if echo "$status" | grep -qi "enabled"; then
    echo "enabled"
    return 0
  else
    echo "disabled"
    return 1
  fi
}

# Check stealth mode
check_stealth() {
  local status
  status=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getstealthmode 2>/dev/null)
  if echo "$status" | grep -qi "enabled"; then
    echo "enabled"
    return 0
  else
    echo "disabled"
    return 1
  fi
}

# Check auto login
check_auto_login() {
  local status
  status=$(defaults read /Library/Preferences/com.apple.loginwindow autoLoginUser 2>/dev/null)
  if [[ -n "$status" ]]; then
    echo "enabled"
    return 1  # Auto login enabled is BAD
  else
    echo "disabled"
    return 0
  fi
}

# Check remote login (SSH)
check_remote_login() {
  local status
  status=$(systemsetup -getremotelogin 2>/dev/null)
  if echo "$status" | grep -qi "on"; then
    echo "enabled"
    return 1  # Enabled means potential risk
  else
    echo "disabled"
    return 0
  fi
}

# Check password after sleep
check_password_sleep() {
  local status
  status=$(defaults read com.apple.screensaver askForPassword 2>/dev/null)
  if [[ "$status" == "1" ]]; then
    echo "required"
    return 0
  else
    echo "not required"
    return 1
  fi
}

# --- Action Functions -------------------------------------------------------

# Print check result
print_check() {
  local name="$1"
  local status="$2"
  local good="$3"  # expected good state
  
  local icon
  local padding="%-40s"
  
  if [[ "$status" == "$good" ]] || [[ "$status" == "enabled" && "$good" == "on" ]]; then
    icon="âœ“"
    printf "  $icon $padding %s\n" "$name" "$status"
  else
    icon="âš "
    printf "  $icon $padding %s\n" "$name" "$status"
  fi
}

# Full security audit
action_run() {
  msg_info "ðŸ”’ macOS Security Audit"
  echo ""
  
  local passed=0
  local total=0
  
  # System Protection
  echo "System Protection:"
  
  total=$((total + 1))
  local sip_status
  sip_status=$(check_sip)
  if [[ "$sip_status" == "enabled" ]]; then
    passed=$((passed + 1))
    echo "  âœ“ System Integrity Protection (SIP)     Enabled"
  else
    echo "  âš  System Integrity Protection (SIP)     Disabled"
  fi
  
  total=$((total + 1))
  local fv_status
  fv_status=$(check_filevault)
  if [[ "$fv_status" == "enabled" ]]; then
    passed=$((passed + 1))
    echo "  âœ“ FileVault Disk Encryption             Enabled"
  elif [[ "$fv_status" == "encrypting" ]]; then
    passed=$((passed + 1))
    echo "  âš  FileVault Disk Encryption             In Progress"
  else
    echo "  âš  FileVault Disk Encryption             Disabled"
  fi
  
  total=$((total + 1))
  local gk_status
  gk_status=$(check_gatekeeper)
  if [[ "$gk_status" == "enabled" ]]; then
    passed=$((passed + 1))
    echo "  âœ“ Gatekeeper                            Enabled"
  else
    echo "  âš  Gatekeeper                            Disabled"
  fi
  
  total=$((total + 1))
  local fw_status
  fw_status=$(check_firewall)
  if [[ "$fw_status" == "enabled" ]]; then
    passed=$((passed + 1))
    echo "  âœ“ Application Firewall                  Enabled"
  else
    echo "  âš  Application Firewall                  Disabled"
  fi
  
  echo ""
  echo "Authentication:"
  
  total=$((total + 1))
  local pw_status
  pw_status=$(check_password_sleep)
  if [[ "$pw_status" == "required" ]]; then
    passed=$((passed + 1))
    echo "  âœ“ Password Required After Sleep         Yes"
  else
    echo "  âš  Password Required After Sleep         No"
  fi
  
  total=$((total + 1))
  local auto_status
  auto_status=$(check_auto_login)
  if [[ "$auto_status" == "disabled" ]]; then
    passed=$((passed + 1))
    echo "  âœ“ Automatic Login                       Disabled"
  else
    echo "  âš  Automatic Login                       Enabled (risky)"
  fi
  
  echo ""
  echo "Network:"
  
  total=$((total + 1))
  local stealth_status
  stealth_status=$(check_stealth)
  if [[ "$stealth_status" == "enabled" ]]; then
    passed=$((passed + 1))
    echo "  âœ“ Firewall Stealth Mode                 Enabled"
  else
    echo "  âš  Firewall Stealth Mode                 Disabled"
  fi
  
  total=$((total + 1))
  local ssh_status
  ssh_status=$(check_remote_login)
  if [[ "$ssh_status" == "disabled" ]]; then
    passed=$((passed + 1))
    echo "  âœ“ Remote Login (SSH)                    Disabled"
  else
    echo "  âš  Remote Login (SSH)                    Enabled"
  fi
  
  echo ""
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  
  local failed=$((total - passed))
  
  if [[ $passed -eq $total ]]; then
    msg_success "Score: $passed/$total checks passed - Excellent!"
  elif [[ $failed -le 2 ]]; then
    msg_info "Score: $passed/$total checks passed"
    msg_warning "$failed item(s) need attention"
  else
    msg_warning "Score: $passed/$total checks passed"
    msg_warning "$failed items need attention"
  fi
}

# Quick check
action_quick() {
  msg_info "Quick Security Check"
  echo ""
  
  local all_good=true
  
  local sip_status
  sip_status=$(check_sip)
  if [[ "$sip_status" == "enabled" ]]; then
    echo "  SIP:        âœ“ Enabled"
  else
    echo "  SIP:        âœ— Disabled"
    all_good=false
  fi
  
  local fv_status
  fv_status=$(check_filevault)
  if [[ "$fv_status" == "enabled" ]] || [[ "$fv_status" == "encrypting" ]]; then
    echo "  FileVault:  âœ“ Enabled"
  else
    echo "  FileVault:  âœ— Disabled"
    all_good=false
  fi
  
  local gk_status
  gk_status=$(check_gatekeeper)
  if [[ "$gk_status" == "enabled" ]]; then
    echo "  Gatekeeper: âœ“ Enabled"
  else
    echo "  Gatekeeper: âœ— Disabled"
    all_good=false
  fi
  
  local fw_status
  fw_status=$(check_firewall)
  if [[ "$fw_status" == "enabled" ]]; then
    echo "  Firewall:   âœ“ Enabled"
  else
    echo "  Firewall:   âœ— Disabled"
    all_good=false
  fi
  
  echo ""
  
  if $all_good; then
    msg_success "All critical protections active âœ“"
  else
    msg_warning "Some critical protections are disabled!"
  fi
}

# Check SIP details
action_sip() {
  local status
  status=$(csrutil status 2>/dev/null)
  
  if echo "$status" | grep -q "enabled"; then
    msg_success "System Integrity Protection: Enabled âœ“"
  else
    msg_warning "System Integrity Protection: Disabled âœ—"
  fi
  
  echo ""
  echo "SIP protects:"
  echo "  â€¢ /System"
  echo "  â€¢ /usr (except /usr/local)"
  echo "  â€¢ /bin, /sbin"
  echo "  â€¢ Preinstalled apps"
  echo "  â€¢ Kernel extensions"
  echo ""
  msg_info "To modify SIP, boot into Recovery Mode (Cmd+R at startup)."
}

# Check FileVault details
action_filevault() {
  local status
  status=$(fdesetup status 2>/dev/null)
  
  if echo "$status" | grep -qi "FileVault is On"; then
    msg_success "FileVault Status: Enabled âœ“"
    echo ""
    echo "  Encryption:   Fully Encrypted"
    
    # List enabled users
    local users
    users=$(fdesetup list 2>/dev/null | wc -l | tr -d ' ')
    echo "  Users:        $users enabled user(s)"
    
  elif echo "$status" | grep -qi "in progress"; then
    msg_warning "FileVault Status: Encryption In Progress"
    echo ""
    echo "$status"
  else
    msg_warning "FileVault Status: Disabled âœ—"
    echo ""
    msg_info "Enable FileVault in System Settings > Privacy & Security > FileVault"
  fi
}

# Check Gatekeeper details
action_gatekeeper() {
  local status
  status=$(spctl --status 2>/dev/null)
  
  if echo "$status" | grep -q "assessments enabled"; then
    msg_success "Gatekeeper: Enabled âœ“"
    echo ""
    echo "Gatekeeper blocks:"
    echo "  â€¢ Unsigned applications"
    echo "  â€¢ Apps not from identified developers"
    echo "  â€¢ Malware-infected software"
  else
    msg_warning "Gatekeeper: Disabled âœ—"
    echo ""
    msg_info "Enable with: sudo spctl --master-enable"
  fi
}

# Check firewall details
action_firewall() {
  local global_status
  global_status=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate 2>/dev/null)
  
  if echo "$global_status" | grep -qi "enabled"; then
    msg_success "Application Firewall: Enabled âœ“"
  else
    msg_warning "Application Firewall: Disabled âœ—"
  fi
  
  echo ""
  
  local stealth_status
  stealth_status=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getstealthmode 2>/dev/null)
  
  if echo "$stealth_status" | grep -qi "enabled"; then
    echo "  Stealth Mode:     Enabled âœ“"
  else
    echo "  Stealth Mode:     Disabled"
  fi
  
  local block_status
  block_status=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getblockall 2>/dev/null)
  
  if echo "$block_status" | grep -qi "enabled"; then
    echo "  Block All:        Enabled"
  else
    echo "  Block All:        Disabled"
  fi
  
  echo ""
  msg_info "Manage in System Settings > Network > Firewall"
}

# --- Main Logic -------------------------------------------------------------
main() {
  if [[ -z "$1" ]] || [[ "$1" == "--help" ]]; then
    usage
  fi

  local action="$1"
  shift

  case "$action" in
    run)
      action_run
      ;;
    quick)
      action_quick
      ;;
    sip)
      action_sip
      ;;
    filevault)
      action_filevault
      ;;
    gatekeeper)
      action_gatekeeper
      ;;
    firewall)
      action_firewall
      ;;
    *)
      die "Unknown action '$action'. Run 'fc fc-audit --help' for available actions."
      ;;
  esac
}

main "$@"
