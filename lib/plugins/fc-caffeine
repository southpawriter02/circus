#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc-caffeine
#
# DESCRIPTION:  Prevent the system from sleeping. Useful for long-running
#               tasks, presentations, downloads, or any situation where you
#               need your system to stay awake.
#
# CROSS-PLATFORM:
#   - macOS: Uses caffeinate (built-in)
#   - Linux: Uses systemd-inhibit or caffeine
#
# ACTIONS:
#   on          - Prevent sleep indefinitely (runs in background)
#   off         - Allow system to sleep normally again
#   for [min]   - Prevent sleep for a specific number of minutes
#   status      - Check if caffeine is currently active
#
# EXAMPLES:
#   fc caffeine on          # Prevent sleep until 'off' is called
#   fc caffeine off         # Allow sleep again
#   fc caffeine for 60      # Prevent sleep for 1 hour
#   fc caffeine status      # Check if caffeine is active
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Configuration ----------------------------------------------------------
readonly STATE_DIR="$HOME/.circus"
readonly PID_FILE="$STATE_DIR/caffeinate.pid"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc caffeine <action> [duration]"
  echo ""
  msg_info "Prevents the system from sleeping."
  echo ""
  msg_info "Actions:"
  echo "  on        - Prevent sleep indefinitely. Runs in the background."
  echo "  off       - Allow the system to sleep again."
  echo "  for [min] - Prevent sleep for a specific number of minutes."
  echo "  status    - Check if caffeine is currently active."
  echo ""
  msg_info "Examples:"
  echo "  fc caffeine on         # Keep awake until 'off' is called"
  echo "  fc caffeine off        # Allow sleep again"
  echo "  fc caffeine for 30     # Keep awake for 30 minutes"
  echo "  fc caffeine status     # Check if active"
  echo ""
  if is_linux; then
    msg_info "Linux: Uses systemd-inhibit or caffeine package"
  fi
  exit 0
}

# --- Action Functions -------------------------------------------------------

action_on() {
  if [ -f "$PID_FILE" ]; then
    msg_warning "Caffeine is already active. Run 'fc caffeine off' to disable it."
    return 0
  fi
  
  msg_info "Preventing sleep indefinitely. Run 'fc caffeine off' to restore normal behavior."
  mkdir -p "$STATE_DIR"
  
  if is_macos; then
    caffeinate -dis &
    echo $! > "$PID_FILE"
  elif is_linux; then
    if command -v systemd-inhibit &>/dev/null; then
      # systemd-inhibit needs a command to run, use sleep infinity
      systemd-inhibit --what=idle:sleep:handle-lid-switch --why="fc caffeine" sleep infinity &
      echo $! > "$PID_FILE"
    elif command -v caffeine &>/dev/null; then
      caffeine &
      echo $! > "$PID_FILE"
    else
      die "No sleep prevention tool found. Install caffeine or use systemd-inhibit."
    fi
  fi
  
  msg_success "Caffeine is now ON."
}

action_off() {
  if [ ! -f "$PID_FILE" ]; then
    msg_warning "Caffeine is not currently active."
    return 0
  fi
  
  msg_info "Allowing the system to sleep normally again..."
  kill "$(cat "$PID_FILE")" 2>/dev/null || true
  rm "$PID_FILE"
  msg_success "Caffeine is now OFF."
}

action_for() {
  local minutes="$1"
  
  if [ -z "$minutes" ]; then
    die "Please provide a duration in minutes."
  fi
  
  local seconds=$((minutes * 60))
  msg_info "Preventing sleep for $minutes minutes..."
  
  if is_macos; then
    caffeinate -dit "$seconds"
  elif is_linux; then
    if command -v systemd-inhibit &>/dev/null; then
      systemd-inhibit --what=idle:sleep --why="fc caffeine for $minutes min" sleep "$seconds"
    elif command -v caffeine &>/dev/null; then
      timeout "${minutes}m" caffeine
    else
      sleep "$seconds"
    fi
  fi
  
  msg_success "Caffeine session completed after $minutes minutes."
}

action_status() {
  if [ -f "$PID_FILE" ]; then
    local pid
    pid=$(cat "$PID_FILE")
    if kill -0 "$pid" 2>/dev/null; then
      msg_success "Caffeine is ON (preventing sleep indefinitely). PID: $pid"
    else
      rm "$PID_FILE"
      msg_warning "Caffeine is OFF. (Stale PID file cleaned up)"
    fi
  else
    msg_warning "Caffeine is OFF."
  fi
}

# --- Main Logic -------------------------------------------------------------
main() {
  if [ -z "$1" ] || [ "$1" == "--help" ]; then
    usage
  fi

  ACTION="$1"

  case "$ACTION" in
    on)
      action_on
      ;;
    off)
      action_off
      ;;
    for)
      action_for "$2"
      ;;
    status)
      action_status
      ;;
    *)
      die "Unknown action '$ACTION'. Run 'fc caffeine --help' for available actions."
      ;;
  esac
}

main "$@"
