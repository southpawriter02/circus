#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         airdrop
#
# DESCRIPTION:  This command manages AirDrop visibility.
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the centralized initialization script to set up the environment.
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc airdrop <action>"
  echo ""
  msg_info "Manages AirDrop visibility."
  echo ""
  msg_info "Actions:"
  echo "  on        - Enable AirDrop for everyone."
  echo "  off       - Disable AirDrop."
  echo "  contacts  - Enable AirDrop for contacts only."
  echo "  status    - Show the current AirDrop status."
  echo ""
  exit 0
}

# --- Main Logic -------------------------------------------------------------
main() {
  # This plugin only works on macOS
  require_macos "fc airdrop"
  
  if [ -z "$1" ] || [ "$1" == "--help" ]; then
    usage
  fi

  ACTION="$1"

  case "$ACTION" in
    on)
      msg_info "Enabling AirDrop for everyone..."
      defaults write com.apple.sharingd DiscoverableMode -string "Everyone"
      msg_success "AirDrop is now discoverable by everyone."
      ;;
    off)
      msg_info "Disabling AirDrop..."
      defaults write com.apple.sharingd DiscoverableMode -string "Off"
      msg_success "AirDrop is now off."
      ;;
    contacts)
      msg_info "Enabling AirDrop for contacts only..."
      defaults write com.apple.sharingd DiscoverableMode -string "Contacts Only"
      msg_success "AirDrop is now discoverable by contacts only."
      ;;
    status)
      msg_info "Checking AirDrop status..."
      local mode
      mode=$(defaults read com.apple.sharingd DiscoverableMode)
      msg_success "AirDrop is currently set to: $mode"
      ;;
    *)
      die "Unknown action '$ACTION'. Run 'fc airdrop --help' for available actions."
      ;;
  esac
}

main "$@"
