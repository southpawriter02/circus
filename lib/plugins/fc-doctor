#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         doctor
#
# DESCRIPTION:  This plugin runs a series of diagnostic checks to ensure the
#               system is in a healthy and correctly configured state.
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the centralized initialization script to set up the environment.
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Usage Information ---
usage() {
  msg_info "Usage: fc doctor"
  echo ""
  msg_info "Runs a series of diagnostic checks on your system."
  exit 0
}

# --- Check Functions ---

check_brew() {
  msg_info "Checking Homebrew status..."
  if ! command -v brew >/dev/null 2>&1; then
    die "Homebrew is not installed. Please run the main installer."
  fi

  # We temporarily disable `set -e` because `brew doctor` can return a non-zero
  # exit code for warnings, which we want to handle gracefully.
  set +e
  local brew_output
  brew_output=$(brew doctor 2>&1)
  local brew_status=$?
  set -e

  if [ $brew_status -eq 0 ]; then
    msg_success "Homebrew is healthy."
  else
    msg_warning "Homebrew has some issues. Please review the output below:"
    echo "$brew_output"
  fi
}

check_critical_tools() {
  msg_info "Checking for critical tools..."
  local missing_tools=0
  local tools_to_check=("git" "zsh" "op" "shellcheck" "gpg")

  for tool in "${tools_to_check[@]}"; do
    if command -v "$tool" >/dev/null 2>&1; then
      msg_success "  [✓] Found '$tool'"
    else
      msg_error "  [✗] '$tool' is missing."
      ((missing_tools++))
    fi
  done

  if [ $missing_tools -gt 0 ]; then
    msg_warning "$missing_tools critical tool(s) are missing. Consider running the installer."
  else
    msg_success "All critical tools are installed."
  fi
}

# --- Main Logic ---
main() {
  if [ "$1" == "--help" ]; then
    usage
  fi

  msg_info "Starting system health check..."
  echo ""

  check_brew
  echo ""

  check_critical_tools
  echo ""

  msg_success "System health check complete."
}

main "$@"
