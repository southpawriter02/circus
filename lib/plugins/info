#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         info
#
# DESCRIPTION:  This command displays a summary of the system's hardware and
#               software configuration.
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the centralized initialization script to set up the environment.
source "$(dirname "${BASH_SOURCE[0]}")/../../lib/init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  ui_header "System Information"
  echo "Displays a summary of the system's configuration."
  echo ""
  echo "Usage: fc info"
  exit 0
}

# --- Main Logic -------------------------------------------------------------
main() {
  # Allow overriding commands for testing purposes.
  local sw_vers_cmd=${SW_VERS_CMD:-sw_vers}
  local sysctl_cmd=${SYSCTL_CMD:-sysctl}
  local hostname_cmd=${HOSTNAME_CMD:-hostname}
  local uptime_cmd=${UPTIME_CMD:-uptime}
  local os_name=${OS_NAME:-$(uname)}

  if [ "$1" == "--help" ]; then
    usage
  fi

  ui_header "System Information"

  local os_info=""
  local host_info=""
  local uptime_info=""
  local cpu_info=""
  local mem_info=""

  # --- Software Info ---
  # Detect platform and use appropriate commands
  if [[ "$os_name" == "Darwin" ]]; then
    os_info="$($sw_vers_cmd -productName) $($sw_vers_cmd -productVersion) ($($sw_vers_cmd -buildVersion))"
  else
    # Linux fallback
    if [ -f /etc/os-release ]; then
      os_info="$(grep '^PRETTY_NAME=' /etc/os-release | cut -d'"' -f2)"
    else
      os_info="$(uname -s) $(uname -r)"
    fi
  fi

  host_info="$($hostname_cmd)"
  uptime_info="$($uptime_cmd | awk -F, '{print $1}' | cut -d' ' -f 4-)"

  # --- Hardware Info ---
  if [[ "$os_name" == "Darwin" ]]; then
    # macOS-specific hardware info
    local model
    model="$($sysctl_cmd -n hw.model)"
    cpu_info="$($sysctl_cmd -n machdep.cpu.brand_string)"

    # Append model to CPU info for display if desired, or keep separate
    cpu_info="$cpu_info ($model)"

    # Get memory size in bytes and convert to GB
    local mem_bytes
    mem_bytes=$($sysctl_cmd -n hw.memsize)
    local mem_gb=$((mem_bytes / 1024 / 1024 / 1024))
    mem_info="${mem_gb} GB"
  else
    # Linux fallback
    if command -v lscpu >/dev/null 2>&1; then
      cpu_info="$(lscpu | grep "^Model name:" | cut -d':' -f2 | xargs)"
    fi
    if [ -f /proc/meminfo ]; then
      local mem_kb
      mem_kb=$(grep '^MemTotal:' /proc/meminfo | awk '{print $2}')
      local mem_gb=$((mem_kb / 1024 / 1024))
      mem_info="${mem_gb} GB"
    fi
  fi

  # Display as a table
  ui_table "20,40" "Property,Value" \
    "OS Version,$os_info" \
    "Hostname,$host_info" \
    "Uptime,$uptime_info" \
    "CPU,$cpu_info" \
    "Memory,$mem_info"

  echo ""
}

main "$@"
