#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         backup
#
# DESCRIPTION:  This command backs up essential dotfiles to a specified
#               (and configurable) cloud or local directory.
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
# Source the centralized initialization script to set up the environment.
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc backup"
  echo ""
  msg_info "Backs up essential dotfiles to a timestamped directory."
  msg_info "The backup location and the list of files to back up are configurable"
  msg_info "within this script."
  echo ""
  exit 0
}

# --- Main Logic -------------------------------------------------------------
main() {
  local rsync_cmd=${RSYNC_CMD:-rsync}

  if ! command -v "$rsync_cmd" &> /dev/null; then
    die "This command requires 'rsync'. Please install it first."
  fi

  if [ "$1" == "--help" ]; then
    usage
  fi

  # --- Configuration --------------------------------------------------------
  local BACKUP_LOCATION_BASE="$HOME/Library/Mobile Documents/com~apple~CloudDocs/Backups"
  local DOTFILES_TO_BACKUP=(
    ".zshrc"
    ".zpreztorc"
    ".gitconfig"
    ".gnupg"
  )

  # --- Backup Process -------------------------------------------------------
  msg_info "Starting dotfiles backup..."

  mkdir -p "$BACKUP_LOCATION_BASE"

  local timestamp
  timestamp=$(date +%Y-%m-%d-%H%M%S)
  local backup_dir="$BACKUP_LOCATION_BASE/dotfiles-backup-$timestamp"
  mkdir -p "$backup_dir"

  msg_info "Backup destination: $backup_dir"
  echo ""

  local items_backed_up=0
  local items_skipped=0

  for item in "${DOTFILES_TO_BACKUP[@]}"; do
    local source_path="$HOME/$item"
    if [ -e "$source_path" ]; then
      msg_info "  -> Backing up '$item'..."
      rsync -a "$source_path" "$backup_dir/"
      ((items_backed_up++))
    else
      msg_warning "  -> Skipping '$item' (does not exist)."
      ((items_skipped++))
    fi
  done

  echo ""
  msg_success "Backup complete!"
  msg_info "Items backed up: $items_backed_up"
  msg_info "Items skipped: $items_skipped"
}

main "$@"
