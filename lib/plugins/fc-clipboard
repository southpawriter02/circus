#!/usr/bin/env bash

# ==============================================================================
#
# FILE:         fc-clipboard
#
# DESCRIPTION:  Clipboard utilitiesâ€”view, clear, copy, and transform
#               clipboard contents. Useful for scripting, debugging clipboard
#               issues, removing rich text formatting, and quick text operations.
#
# CROSS-PLATFORM:
#   - macOS: Uses pbcopy/pbpaste (built-in)
#   - Linux: Uses xclip, xsel, or wl-copy/wl-paste
#
# ACTIONS:
#   show        Display current clipboard contents
#   clear       Clear the clipboard completely
#   copy        Copy text to clipboard
#   plain       Convert clipboard to plain text
#   count       Show character, word, and line count
#
# ==============================================================================

# --- Initialization ---------------------------------------------------------
source "$(dirname "${BASH_SOURCE[0]}")/../init.sh"

# --- Help and Usage ---------------------------------------------------------
usage() {
  msg_info "Usage: fc clipboard <action> [text]"
  echo ""
  msg_info "Clipboard utilities."
  echo ""
  msg_info "Actions:"
  echo "  show          - Show current clipboard contents"
  echo "  clear         - Clear the clipboard"
  echo "  copy <text>   - Copy text to clipboard (or pipe input)"
  echo "  plain         - Convert clipboard to plain text (remove formatting)"
  echo "  count         - Count characters/words/lines in clipboard"
  echo ""
  msg_info "Examples:"
  echo "  fc clipboard show                   # View contents"
  echo "  fc clipboard copy \"Hello World\"    # Copy text"
  echo "  echo \"text\" | fc clipboard copy    # Copy from pipe"
  echo "  fc clipboard clear                  # Clear after sensitive copy"
  echo ""
  if is_linux; then
    msg_info "Linux: Uses xclip, xsel, or wl-copy"
  fi
  exit 0
}


# --- Action Functions -------------------------------------------------------

# Show clipboard contents
action_show() {
  local content
  content=$(os_clipboard_paste 2>/dev/null)
  
  if [[ -z "$content" ]]; then
    msg_warning "Clipboard is empty."
    return 0
  fi
  
  local char_count=${#content}
  local line_count
  line_count=$(echo "$content" | wc -l | tr -d ' ')
  
  msg_info "Clipboard Contents:"
  echo "---"
  
  # Truncate very long content
  if [[ $char_count -gt 1000 ]]; then
    echo "${content:0:1000}"
    echo "... (truncated, showing first 1000 of $char_count characters)"
  else
    echo "$content"
  fi
  
  echo "---"
  echo ""
  echo "Size: $char_count characters, $line_count lines"
}

# Clear clipboard
action_clear() {
  echo -n "" | os_clipboard_copy
  msg_success "Clipboard cleared"
}

# Copy text to clipboard
action_copy() {
  local text="$*"
  
  if [[ -z "$text" ]]; then
    # Read from stdin if no arguments
    if [[ -t 0 ]]; then
      die "No text provided. Usage: fc clipboard copy <text> OR pipe input."
    else
      text=$(cat)
    fi
  fi
  
  echo -n "$text" | os_clipboard_copy
  local char_count=${#text}
  msg_success "Copied $char_count characters to clipboard"
}

# Convert clipboard to plain text
action_plain() {
  local content
  content=$(os_clipboard_paste 2>/dev/null)
  
  if [[ -z "$content" ]]; then
    msg_warning "Clipboard is empty."
    return 0
  fi
  
  # Re-copy as plain text
  echo -n "$content" | os_clipboard_copy
  msg_success "Rich text formatting removed (clipboard is now plain text)"
}

# Count clipboard contents
action_count() {
  local content
  content=$(os_clipboard_paste 2>/dev/null)
  
  if [[ -z "$content" ]]; then
    msg_warning "Clipboard is empty."
    return 0
  fi
  
  local char_count=${#content}
  local word_count
  local line_count
  word_count=$(echo "$content" | wc -w | tr -d ' ')
  line_count=$(echo "$content" | wc -l | tr -d ' ')
  
  msg_info "Clipboard Statistics:"
  echo "  Characters:  $char_count"
  echo "  Words:       $word_count"
  echo "  Lines:       $line_count"
}

# --- Main Logic -------------------------------------------------------------
main() {
  if [[ -z "$1" ]] || [[ "$1" == "--help" ]]; then
    usage
  fi

  local action="$1"
  shift

  case "$action" in
    show)
      action_show
      ;;
    clear)
      action_clear
      ;;
    copy)
      action_copy "$@"
      ;;
    plain)
      action_plain
      ;;
    count)
      action_count
      ;;
    *)
      die "Unknown action '$action'. Run 'fc clipboard --help' for available actions."
      ;;
  esac
}

main "$@"
